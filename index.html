<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>Unsere Wunschliste</title>
  <meta name="robots" content="noindex, nofollow">

  <style>
    :root {
      --bg-root: #F9F8F6;
      --bg-card: #FFFFFF;
      --bg-panel: #F2F1EF;
      --text-primary: #1D1D1F;
      --text-secondary: #86868B;
      --text-tertiary: #C7C7CC;
      --accent: #1D1D1F;
      --btn-bg: #EAEAEA;
      --btn-text: #1D1D1F;
      --btn-bg-hover: #E1E1E1;
      --radius-card: 16px;
      --radius-btn: 999px;
      --radius-input: 12px;
      --shadow-soft: 0 2px 12px rgba(0, 0, 0, 0.03);
      --shadow-hover: 0 4px 20px rgba(0, 0, 0, 0.05);
      --ease: cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      outline: none;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg-root);
      color: var(--text-primary);
      margin: 0;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      padding-bottom: 120px;
    }

    h1 {
      font-size: 26px;
      font-weight: 600;
      text-align: center;
      margin: 0 0 16px 0;
      letter-spacing: -0.015em;
    }

    h2 {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-secondary);
      margin: 0;
    }

    p.intro {
      font-size: 16px;
      line-height: 1.6;
      color: #666;
      text-align: center;
      max-width: 540px;
      margin: 0 auto 32px auto;
      font-weight: 400;
    }

    .wrap {
      max-width: 680px;
      margin: 0 auto;
      padding: 60px 24px;
    }

    .hero {
      width: 100%;
      height: 380px;
      object-fit: cover;
      border-radius: var(--radius-card);
      margin-bottom: 40px;
      box-shadow: var(--shadow-soft);
      filter: sepia(0.05) contrast(0.96);
    }

    .group-gift {
      background: var(--bg-card);
      border-radius: var(--radius-card);
      box-shadow: var(--shadow-soft);
      padding: 24px;
      margin-bottom: 32px;
      border: 1px solid rgba(0, 0, 0, 0.03);
    }

    .iban-container {
      background: #fff;
      border: 1px solid rgba(0, 0, 0, 0.06);
      border-radius: 999px;
      padding: 12px 16px;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: all 0.2s var(--ease);
      margin-top: 10px;
    }

    .iban-container:hover {
      border-color: #CCC;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .iban-text {
      font-weight: 500;
      font-size: 15px;
      letter-spacing: 0.02em;
      color: #333;
      white-space: nowrap;
    }

    .copy-icon {
      width: 16px;
      height: 16px;
      fill: #888;
    }

    .progress-container {
      margin-bottom: 32px;
      text-align: center;
      display: none;
    }

    .progress-text {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      font-weight: 500;
    }

    .progress-track {
      width: 100%;
      height: 4px;
      background: #E5E5E5;
      border-radius: 2px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--text-secondary);
      width: 0%;
      transition: width 1s var(--ease);
    }

    .controls {
      background: var(--bg-card);
      padding: 20px;
      border-radius: var(--radius-card);
      box-shadow: var(--shadow-soft);
      margin-bottom: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .search-row {
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 12px 16px 12px 40px;
      font-size: 15px;
      border: 1px solid #E5E5E5;
      border-radius: var(--radius-input);
      background: #FCFCFC;
      transition: all 0.2s;
    }

    .search-input:focus {
      border-color: #CCC;
      background: #FFF;
    }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      width: 16px;
      height: 16px;
      fill: var(--text-secondary);
      pointer-events: none;
    }

    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
    }

    .toggles {
      display: flex;
      gap: 12px;
    }

    .toggle-btn {
      background: transparent;
      border: 1px solid #E5E5E5;
      padding: 8px 14px;
      border-radius: 99px;
      font-size: 13px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
    }

    .toggle-btn.active {
      background: var(--text-primary);
      color: #FFF;
      border-color: var(--text-primary);
    }

    .sort-select {
      border: none;
      background: transparent;
      font-size: 13px;
      color: var(--text-primary);
      font-weight: 500;
      cursor: pointer;
      padding-right: 16px;
      text-align: right;
      appearance: none;
    }

    .section-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 36px 0 14px 0;
      padding: 0 4px;
      cursor: pointer;
      user-select: none;
    }

    .section-title:hover {
      opacity: 0.85;
    }

    .section-chevron {
      width: 12px;
      height: 12px;
      fill: var(--text-secondary);
      transition: transform 0.3s;
    }

    .section-title.collapsed .section-chevron {
      transform: rotate(-90deg);
    }

    .gift-group {
      transition: height 0.3s var(--ease), opacity 0.3s var(--ease);
      overflow: hidden;
    }

    .gift-group.collapsed {
      height: 0 !important;
      opacity: 0;
    }

    .item {
      background: var(--bg-card);
      padding: 24px;
      margin-bottom: 12px;
      border-radius: var(--radius-card);
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 20px;
      align-items: center;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.02);
      transition: all 0.2s var(--ease);
      border: 1px solid transparent;
    }

    .item:hover {
      box-shadow: var(--shadow-hover);
      transform: translateY(-1px);
      border-color: rgba(0, 0, 0, 0.03);
    }

    .item-content {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
    }

    .item-title {
      font-size: 17px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .meta {
      font-size: 14px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .meta a {
      color: var(--text-secondary);
      text-decoration: none;
      position: relative;
      transition: color 0.2s;
    }

    .meta a:hover {
      color: var(--text-primary);
    }

    .meta a::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 1px;
      background: currentColor;
      opacity: 0.3;
    }

    .sep {
      width: 2px;
      height: 2px;
      background: #CCC;
      border-radius: 50%;
    }

    button {
      background: var(--btn-bg);
      color: var(--btn-text);
      border: none;
      padding: 10px 18px;
      border-radius: var(--radius-btn);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
      min-width: 120px;
      text-align: center;
    }

    button:hover:not(:disabled) {
      background: var(--btn-bg-hover);
    }

    button:disabled {
      background: #F5F5F5;
      color: #BBB;
      cursor: default;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
      font-size: 15px;
    }

    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: #222;
      color: #FFF;
      padding: 12px 24px;
      border-radius: 99px;
      font-size: 14px;
      opacity: 0;
      transition: all 0.4s;
      z-index: 1000;
      pointer-events: none;
    }

    .toast.active {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .skeleton {
      height: 72px;
      background: #EEE;
      border-radius: var(--radius-card);
      margin-bottom: 12px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { opacity: 0.5; }
      50% { opacity: 0.85; }
      100% { opacity: 0.5; }
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(4px);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 999;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }

    .modal-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }

    .modal {
      background: #FFF;
      width: 90%;
      max-width: 360px;
      padding: 28px;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      text-align: left;
      transform: scale(0.95);
      transition: transform 0.3s;
    }

    .modal-overlay.active .modal {
      transform: scale(1);
    }

    .modal h3 {
      font-size: 18px;
      margin: 0 0 8px 0;
    }

    .modal p {
      font-size: 14px;
      color: #666;
      margin: 0 0 18px 0;
      line-height: 1.5;
    }

    .modal label {
      display: block;
      font-size: 12px;
      color: var(--text-secondary);
      margin: 12px 0 6px 0;
    }

    .modal input, .modal select {
      width: 100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid #E5E5E5;
      font-size: 15px;
      background: #FCFCFC;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 18px;
    }

    .modal-btn {
      flex: 1;
      padding: 12px;
      border-radius: 12px;
      font-size: 15px;
      min-width: 0;
    }

    .modal-btn.primary {
      background: #1D1D1F;
      color: #FFF;
    }

    .modal-btn.secondary {
      background: #F5F5F5;
      color: #333;
    }

    @media (max-width: 600px) {
      .wrap { padding: 40px 20px; }
      .hero { height: 280px; }
      .item { grid-template-columns: 1fr; gap: 16px; padding: 20px; }
      button { width: 100%; }
      .filter-row { flex-direction: column; align-items: stretch; }
      .toggles { justify-content: space-between; }
      .sort-select { text-align: left; margin-top: 8px; }
      .iban-container { width: 100%; justify-content: center; }
      .iban-text { font-size: 13px; overflow: hidden; text-overflow: ellipsis; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <img src="https://drive.google.com/thumbnail?id=1WYWYZjvu1wDPXqNuzFNPFI2quZTky3q0&sz=w2000" alt="Brautpaar" class="hero">

    <h1>Unsere Hochzeitswunschliste</h1>
    <p class="intro">Wir freuen uns, dass ihr diesen besonderen Tag mit uns feiert. Geschenke sind natürlich kein Muss.</p>

    <div class="group-gift">
      <h2>Sammelgeschenk – KPM Kurland</h2>
      <p>Wer sich an dem KPM Kurland Sammelgeschenk beteiligen möchte, kann dies gerne über unseren Trauzeugen Max Tiefenbacher tun.</p>
      <div class="iban-container" onclick="window.app.copyIBAN()" title="IBAN kopieren">
        <svg class="copy-icon" viewBox="0 0 24 24">
          <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z" />
        </svg>
        <span class="iban-text">DE89 2007 0024 0191 3888 02</span>
      </div>
      <div style="font-size: 13px; color: #888; margin-top: 8px;">Max Tiefenbacher</div>
    </div>

    <div class="progress-container" id="progress-container">
      <div class="progress-text" id="progress-text">0 von 0 Wünschen erfüllt</div>
      <div class="progress-track">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
    </div>

    <div class="controls">
      <div class="search-row">
        <svg class="search-icon" viewBox="0 0 24 24">
          <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
        </svg>
        <input type="text" id="search-input" class="search-input" placeholder="Wunsch suchen...">
      </div>
      <div class="filter-row">
        <div class="toggles">
          <button class="toggle-btn" id="filter-free">Nur Verfügbare</button>
          <button class="toggle-btn" id="filter-pin">Mein PIN</button>
        </div>
        <select id="sort-select" class="sort-select">
          <option value="cat">Kategorie</option>
          <option value="status">Status (Verfügbar zuerst)</option>
          <option value="price_asc">Preis (aufsteigend)</option>
          <option value="price_desc">Preis (absteigend)</option>
        </select>
      </div>
    </div>

    <div id="list">
      <div class="skeleton"></div>
      <div class="skeleton"></div>
      <div class="skeleton"></div>
    </div>
  </div>

  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <h3 id="modalTitle">Titel</h3>
      <p id="modalText">Text</p>

      <div id="modalFields"></div>

      <div class="modal-actions">
        <button class="modal-btn secondary" id="modalCancel">Abbrechen</button>
        <button class="modal-btn primary" id="modalConfirm">Bestätigen</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Aktion erfolgreich</div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://tpfovcyqqhqlyzcopiwt.supabase.co";
    const SUPABASE_ANON_KEY = "DEIN_ANON_KEY";
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const state = {
      gifts: [],
      myPin: localStorage.getItem("my_pin") || "",
      filter: { search: "", showFreeOnly: false, showPinOnly: false },
      sort: "cat",
      categoryState: {}
    };

    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('active');
      setTimeout(() => t.classList.remove('active'), 2500);
    }

    function parsePrice(priceStr) {
      if (!priceStr) return Infinity;
      const matches = priceStr.match(/[\d.,]+/);
      if (!matches) return Infinity;
      let numStr = matches[0].replace(/\./g, "").replace(",", ".");
      const num = parseFloat(numStr);
      return isNaN(num) ? Infinity : num;
    }

    function availableQty(g) {
      return Math.max(0, (g.quantity ?? 1) - (g.reserved_quantity ?? 0));
    }

    async function loadData() {
      const { data, error } = await sb
        .from("gifts")
        .select("*")
        .order("category")
        .order("title");

      if (error || !data) {
        console.error(error);
        document.getElementById('list').innerHTML = `<div class="empty-state">Fehler beim Laden.</div>`;
        return;
      }

      state.gifts = data;
      render();
      document.getElementById('progress-container').style.display = 'block';
    }

    function render() {
      // progress
      const total = state.gifts.length;
      const reservedCount = state.gifts.filter(g => availableQty(g) === 0).length;
      const width = total > 0 ? (reservedCount / total) * 100 : 0;
      document.getElementById('progress-fill').style.width = width + "%";
      document.getElementById('progress-text').textContent = `${reservedCount} von ${total} Wünschen erfüllt`;

      // filter
      let filtered = state.gifts.filter(g => {
        const s = (g.title || "").toLowerCase();
        const matchesSearch = s.includes(state.filter.search.toLowerCase());
        const matchesFree = !state.filter.showFreeOnly || availableQty(g) > 0;
        return matchesSearch && matchesFree;
      });

      // sort
      filtered.sort((a, b) => {
        if (state.sort === 'price_asc') return parsePrice(a.Preis) - parsePrice(b.Preis);
        if (state.sort === 'price_desc') return parsePrice(b.Preis) - parsePrice(a.Preis);
        if (state.sort === 'status') {
          const aAvail = availableQty(a) > 0;
          const bAvail = availableQty(b) > 0;
          if (aAvail === bAvail) return (a.title || "").localeCompare(b.title || "");
          return aAvail ? -1 : 1;
        }
        if ((a.category || "") !== (b.category || "")) return (a.category || "").localeCompare(b.category || "");
        return (a.title || "").localeCompare(b.title || "");
      });

      // group by category
      const listContainer = document.getElementById('list');
      if (filtered.length === 0) {
        listContainer.innerHTML = `<div class="empty-state">Keine Geschenke gefunden.</div>`;
        return;
      }

      if (state.sort === 'cat') {
        const cats = {};
        filtered.forEach(g => (cats[g.category] ??= []).push(g));

        let html = "";
        for (const c in cats) {
          const isCollapsed = state.categoryState[c] === true;
          html += `
            <div class="section-title ${isCollapsed ? 'collapsed' : ''}" onclick="window.app.toggleCat('${escapeHtml(c)}')">
              <h2>${escapeHtml(c)}</h2>
              <svg class="section-chevron" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
            </div>
            <div class="gift-group ${isCollapsed ? 'collapsed' : ''}" id="cat-${cssId(c)}">
              ${cats[c].map(g => renderItem(g)).join("")}
            </div>
          `;
        }
        listContainer.innerHTML = html;
      } else {
        listContainer.innerHTML = filtered.map(g => renderItem(g)).join("");
      }
    }

    function renderItem(g) {
      const avail = availableQty(g);
      const total = g.quantity ?? 1;
      const given = Math.min(total, g.reserved_quantity ?? 0);

      const statusText = total > 1 ? `${given} von ${total} vergeben` : (avail > 0 ? "frei" : "vergeben");
      const priceHtml = g.Preis ? `<span>${escapeHtml(g.Preis)}</span><div class="sep"></div>` : "";

      let btn = "";
      if (avail > 0) {
        btn = `<button onclick="window.app.openReserve('${escapeJs(g.id)}')">Reservieren</button>`;
      } else {
        btn = `<button disabled>Vergeben</button>`;
      }

      return `
        <div class="item">
          <div class="item-content">
            <div class="item-title">${escapeHtml(g.title || "")}</div>
            <div class="meta">
              ${priceHtml}
              <span>${escapeHtml(statusText)}</span>
              <div class="sep"></div>
              <a href="${escapeHtml(g.url || "#")}" target="_blank" rel="noopener">Zum Shop ↗</a>
            </div>
          </div>
          ${btn}
        </div>
      `;
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, (m) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;" }[m]));
    }
    function escapeJs(str) { return String(str).replace(/'/g, "\\'"); }
    function cssId(str) { return String(str).replace(/[^a-zA-Z0-9_-]/g, "_"); }

    function openModal({ title, text, fieldsHtml, confirmText, onConfirm }) {
      const overlay = document.getElementById('modalOverlay');
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalText').textContent = text;
      document.getElementById('modalFields').innerHTML = fieldsHtml || "";
      document.getElementById('modalConfirm').textContent = confirmText || "Bestätigen";

      const cancelBtn = document.getElementById('modalCancel');
      const confirmBtn = document.getElementById('modalConfirm');

      const close = () => {
        overlay.classList.remove('active');
        cancelBtn.onclick = null;
        confirmBtn.onclick = null;
      };

      cancelBtn.onclick = () => close();
      confirmBtn.onclick = async () => {
        try {
          await onConfirm();
          close();
        } catch (e) {
          console.error(e);
          showToast("Fehler – bitte erneut versuchen");
        }
      };

      overlay.classList.add('active');
    }

    function generatePin() {
      // 4-digit numeric
      const n = Math.floor(1000 + Math.random() * 9000);
      return String(n);
    }

    async function pinExists(pin) {
      const { data, error } = await sb.from("reservations").select("id").eq("pin", pin).limit(1);
      if (error) return false;
      return (data && data.length > 0);
    }

    async function generateUniquePin() {
      for (let i = 0; i < 20; i++) {
        const pin = generatePin();
        if (!(await pinExists(pin))) return pin;
      }
      // fallback
      return String(Date.now()).slice(-4);
    }

    window.app = {
      toggleCat: (cat) => {
        state.categoryState[cat] = !state.categoryState[cat];
        render();
      },
      copyIBAN: () => {
        const text = "DE89 2007 0024 0191 3888 02";
        navigator.clipboard.writeText(text.replace(/\s/g, "")).then(() => showToast("IBAN kopiert")).catch(() => showToast("IBAN kopiert"));
      },

      openReserve: async (giftId) => {
        const g = state.gifts.find(x => String(x.id) === String(giftId));
        if (!g) return;

        const avail = availableQty(g);
        if (avail <= 0) return;

        const suggestedPin = await generateUniquePin();

        const qtyOptions = Array.from({ length: avail }, (_, i) => `<option value="${i + 1}">${i + 1}</option>`).join("");

        openModal({
          title: "Reservieren",
          text: "Bitte wähle eine Menge und merke dir deinen 4-stelligen Code. Damit kannst du später wieder freigeben.",
          fieldsHtml: `
            <label>Menge</label>
            <select id="fieldQty">${qtyOptions}</select>

            <label>Dein 4-stelliger Code</label>
            <input id="fieldPin" inputmode="numeric" maxlength="4" value="${suggestedPin}">
            <div style="margin-top:8px;font-size:12px;color:#888;">
              Tipp: Screenshot machen oder notieren.
            </div>
          `,
          confirmText: "Reservieren",
          onConfirm: async () => {
            const qty = parseInt(document.getElementById("fieldQty").value, 10);
            const pin = String(document.getElementById("fieldPin").value || "").trim();

            if (!/^\d{4}$/.test(pin)) {
              showToast("Bitte 4-stelligen Code eingeben");
              return;
            }

            // Insert reservation
            const { error } = await sb.from("reservations").insert([{ gift_id: String(g.id), pin, qty }]);
            if (error) {
              // Most common: pin already exists, or overbooking
              const msg = (error.message || "").toLowerCase();
              if (msg.includes("duplicate") || msg.includes("unique")) showToast("Code ist vergeben – bitte anderen wählen");
              else if (msg.includes("not enough available")) showToast("Nicht mehr genug verfügbar");
              else showToast("Fehler beim Reservieren");
              return;
            }

            localStorage.setItem("my_pin", pin);
            state.myPin = pin;

            await loadData();
            showToast("Reserviert");
          }
        });
      },

      releaseByPin: async () => {
        openModal({
          title: "Freigeben",
          text: "Gib deinen 4-stelligen Code ein, um deine Reservierung wieder freizugeben.",
          fieldsHtml: `
            <label>Dein 4-stelliger Code</label>
            <input id="fieldReleasePin" inputmode="numeric" maxlength="4" value="${state.myPin || ""}">
          `,
          confirmText: "Freigeben",
          onConfirm: async () => {
            const pin = String(document.getElementById("fieldReleasePin").value || "").trim();
            if (!/^\d{4}$/.test(pin)) {
              showToast("Bitte 4-stelligen Code eingeben");
              return;
            }

            const { error } = await sb.from("reservations").delete().eq("pin", pin);
            if (error) {
              showToast("Fehler beim Freigeben");
              return;
            }

            if (state.myPin === pin) {
              localStorage.removeItem("my_pin");
              state.myPin = "";
            }

            await loadData();
            showToast("Freigegeben");
          }
        });
      }
    };

    // controls
    document.getElementById('search-input').addEventListener('input', (e) => {
      state.filter.search = e.target.value;
      render();
    });

    document.getElementById('filter-free').addEventListener('click', (e) => {
      state.filter.showFreeOnly = !state.filter.showFreeOnly;
      e.target.classList.toggle('active', state.filter.showFreeOnly);
      render();
    });

    document.getElementById('filter-pin').addEventListener('click', async (e) => {
      // Open release modal (simple)
      window.app.releaseByPin();
    });

    document.getElementById('sort-select').addEventListener('change', (e) => {
      state.sort = e.target.value;
      render();
    });

    // init
    loadData();
  </script>
</body>
</html>
