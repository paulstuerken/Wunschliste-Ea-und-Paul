<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Hochzeitswünsche | Ea & Paul</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --bg-body: #E8F0F8;
      --bg-card: #FFFFFF;
      --text-primary: #0F1E30;
      --text-secondary: #3A5878;
      --text-muted: #6B8FAD;
      --border: #C0D6EA;
      --border-hover: #9FC0D8;
      --accent: #1A3A5C;
      --accent-hover: #245080;
      --accent-soft: #D4E4F0;
      --pink: #D64070;
      --pink-hover: #BE2E5C;
      --pink-soft: #FBDBE6;
      --green: #3A7A5C;
      --green-bg: #DAEEE4;
      --red: #C03040;
      --radius-lg: 20px;
      --radius-md: 14px;
      --radius-sm: 10px;
      --radius-pill: 999px;
      --shadow-card: 0 1px 4px rgba(27,42,61,0.04), 0 4px 14px rgba(27,42,61,0.03);
      --shadow-card-hover: 0 2px 8px rgba(27,42,61,0.07), 0 8px 24px rgba(27,42,61,0.05);
      --shadow-float: 0 12px 40px rgba(27,42,61,0.14);
      --ease: cubic-bezier(0.2, 0.8, 0.2, 1);
      --transition: 0.2s var(--ease);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      margin: 0; font-family: "Outfit", sans-serif; background: var(--bg-body);
      color: var(--text-primary); line-height: 1.55; -webkit-font-smoothing: antialiased;
    }
    a { color: inherit; }

    /* ---- Layout ---- */
    .wrap { max-width: 780px; margin: 0 auto; padding: 48px 24px 80px; }

    /* ---- Hero ---- */
    .hero-container { position: relative; margin-bottom: 48px; }
    .hero {
      width: 100%; height: 400px; object-fit: cover; object-position: center 62%; border-radius: var(--radius-lg);
      display: block; background: var(--accent-soft);
    }
    .hero-overlay {
      position: absolute; bottom: 0; left: 0; right: 0; padding: 40px 32px 28px;
      background: linear-gradient(to top, rgba(0,0,0,0.55), transparent);
      border-radius: 0 0 var(--radius-lg) var(--radius-lg);
    }
    .hero-overlay h1 {
      color: #FFF; font-size: 34px; font-weight: 600; margin: 0;
      text-shadow: 0 2px 12px rgba(0,0,0,0.3); text-align: center;
    }
    .hero-overlay p {
      color: rgba(255,255,255,0.85); font-size: 15px; margin: 0;
      text-shadow: 0 1px 6px rgba(0,0,0,0.2);
    }

    /* ---- Progress ---- */
    .progress-container { margin-bottom: 36px; }
    .progress-text {
      text-align: center; font-size: 13px; font-weight: 500;
      color: var(--text-secondary); margin-bottom: 10px; letter-spacing: 0.02em;
    }
    .progress-track { height: 5px; background: var(--border); border-radius: var(--radius-pill); overflow: hidden; }
    .progress-fill { height: 100%; background: var(--pink); width: 0; transition: width 1s var(--ease); border-radius: var(--radius-pill); }

    /* ---- Group Gift Card ---- */
    .group-gift {
      background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg);
      padding: 32px; margin-bottom: 24px; text-align: center;
      box-shadow: var(--shadow-card);
    }
    .group-gift h2 { font-size: 18px; font-weight: 600; margin: 0 0 8px; }
    .group-gift p { color: var(--text-secondary); margin: 0 0 20px; font-size: 15px; }
    .iban-container {
      display: inline-flex; align-items: center; gap: 10px;
      background: var(--accent-soft); padding: 12px 20px; border-radius: var(--radius-pill);
      border: 1px solid var(--border); cursor: pointer;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 14px; user-select: none; transition: all var(--transition);
    }
    .iban-container:hover { border-color: var(--pink); background: var(--pink-soft); }
    .copy-icon { width: 16px; height: 16px; fill: var(--text-muted); }

    /* ---- Release Section ---- */
    .release-section {
      background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg);
      padding: 24px; margin-bottom: 36px; text-align: center;
      box-shadow: var(--shadow-card);
    }
    .release-section h2 { font-size: 14px; font-weight: 600; margin: 0 0 8px; }
    .release-section p { font-size: 13px; color: var(--text-secondary); margin: 0 0 16px; }

    /* ---- Controls ---- */
    .controls { display: flex; flex-direction: column; gap: 14px; margin-bottom: 36px; }
    .search-row { position: relative; }
    .search-input {
      width: 100%; padding: 14px 14px 14px 46px;
      border: 1px solid var(--border); background: var(--bg-card);
      border-radius: var(--radius-md); box-shadow: var(--shadow-card);
      font-size: 15px; outline: none; font-family: inherit;
      transition: border-color var(--transition), box-shadow var(--transition);
    }
    .search-input:focus { border-color: var(--pink); box-shadow: 0 0 0 3px rgba(214,64,112,0.1); }
    .search-input::placeholder { color: var(--text-muted); }
    .search-icon { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); width: 18px; fill: var(--text-muted); pointer-events: none; }

    .filter-row { display: flex; justify-content: space-between; gap: 10px; flex-wrap: wrap; align-items: center; }
    .toggles { display: flex; gap: 8px; flex-wrap: wrap; }
    .toggle-btn {
      background: var(--bg-card); border: 1px solid var(--border); color: var(--text-secondary);
      padding: 8px 16px; font-size: 13px; border-radius: var(--radius-pill);
      cursor: pointer; font-family: inherit; font-weight: 400;
      transition: all var(--transition);
    }
    .toggle-btn:hover { border-color: var(--border-hover); color: var(--text-primary); }
    .toggle-btn.active { background: var(--accent); color: #FFF; border-color: var(--accent); }
    .toggle-btn:hover { border-color: var(--pink); color: var(--pink); }
    .sort-select {
      border: 1px solid transparent; background: transparent; font-size: 13px;
      cursor: pointer; padding: 8px 0; font-family: inherit; color: var(--text-secondary);
    }

    /* ---- Section Titles ---- */
    .section-title {
      display: flex; justify-content: space-between; align-items: center;
      margin: 36px 0 16px; cursor: pointer; user-select: none; gap: 12px;
      padding: 4px 0;
    }
    .section-title h2 { margin: 0; font-size: 17px; font-weight: 600; line-height: 1.3; overflow-wrap: anywhere; }
    .section-chevron {
      width: 14px; height: 14px; fill: var(--text-muted); flex: 0 0 auto;
      transition: transform 0.25s var(--ease);
    }
    .section-title.collapsed .section-chevron { transform: rotate(-90deg); }

    .gift-group { display: block; }
    .gift-group.collapsed { display: none; }

    /* ---- Gift Items ---- */
    .item {
      background: var(--bg-card); padding: 20px; margin-bottom: 12px;
      border-radius: var(--radius-lg); border: 1px solid var(--border);
      display: flex; flex-direction: row; align-items: center; gap: 20px;
      box-shadow: var(--shadow-card);
      transition: box-shadow var(--transition), border-color var(--transition);
    }
    .item:hover { box-shadow: var(--shadow-card-hover); border-color: var(--border-hover); }
    .item.my-reservation { border-color: var(--pink); background: var(--pink-soft); }

    /* ---- Item Image ---- */
    .item-image {
      width: 90px; height: 90px; border-radius: var(--radius-sm);
      object-fit: cover; background: var(--accent-soft); flex-shrink: 0;
      display: block;
    }
    .item-image-placeholder {
      width: 90px; height: 90px; border-radius: var(--radius-sm);
      background: var(--accent-soft); flex-shrink: 0; display: flex;
      align-items: center; justify-content: center;
    }
    .item-image-placeholder svg { width: 28px; height: 28px; fill: var(--text-muted); opacity: 0.4; }

    .item-content { flex: 1; min-width: 0; }
    .item-title { font-size: 16px; font-weight: 500; margin-bottom: 6px; overflow-wrap: anywhere; line-height: 1.35; }
    .meta { font-size: 13px; color: var(--text-secondary); display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .meta a { text-decoration: none; color: var(--text-muted); transition: color var(--transition); }
    .meta a:hover { color: var(--text-primary); }
    .sep { width: 3px; height: 3px; background: var(--border-hover); border-radius: 50%; flex: 0 0 auto; }

    /* ---- Item Actions ---- */
    .item-actions {
      display: flex; flex-direction: column; align-items: stretch; gap: 6px;
      flex-shrink: 0; width: 160px;
    }
    .item-actions button { width: 100%; text-align: center; white-space: normal; word-wrap: break-word; }
    .item-actions .coord-link { font-size:11px; color:var(--text-muted); text-decoration:underline; text-align:center; display:block; }

    /* ---- Buttons ---- */
    button {
      background: var(--pink); color: #FFF; border: none;
      padding: 10px 20px; border-radius: var(--radius-sm);
      font-size: 13px; font-weight: 500; cursor: pointer; font-family: inherit;
      transition: all var(--transition); white-space: nowrap;
    }
    button:hover { background: var(--pink-hover); transform: translateY(-1px); }
    button:active { transform: translateY(0); }
    button:disabled { background: var(--accent-soft); color: var(--text-muted); cursor: default; transform: none; border: 1px solid var(--border); }
    button.reserved {
      background: transparent; color: var(--text-secondary);
      border: 1px solid var(--border);
    }
    button.reserved:hover { background: var(--pink-soft); color: var(--pink); border-color: var(--pink); transform: translateY(-1px); }
    button.undo {
      background: var(--green-bg); color: var(--green); border: 1px solid rgba(74,139,110,0.3);
    }
    button.undo:hover { background: rgba(76,175,80,0.12); transform: translateY(-1px); }

    /* ---- My Reservations ---- */
    #my-reservations-section {
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: var(--radius-lg); padding: 24px; margin-bottom: 36px;
      display: none; box-shadow: var(--shadow-card);
    }
    #my-reservations-section h2 { font-size: 18px; font-weight: 600; margin: 0 0 16px; }

    .empty-state { text-align: center; color: var(--text-muted); padding: 48px 16px; font-size: 14px; }

    /* ---- Modal ---- */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.4);
      backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
      display: flex; justify-content: center; align-items: center;
      z-index: 999; opacity: 0; pointer-events: none; transition: opacity 0.25s;
    }
    .modal-overlay.active { opacity: 1; pointer-events: auto; }
    .modal {
      background: #FFF; width: 90%; max-width: 380px; padding: 32px;
      border-radius: var(--radius-lg); text-align: center;
      transform: scale(0.95) translateY(10px);
      transition: transform 0.3s var(--ease);
      box-shadow: var(--shadow-float);
    }
    .modal-overlay.active .modal { transform: scale(1) translateY(0); }
    .modal h3 { margin: 0 0 12px; font-size: 18px; font-weight: 600; }
    .modal p { color: var(--text-secondary); font-size: 15px; margin: 0 0 20px; }
    .modal-actions { display: flex; gap: 10px; }
    .modal-btn { flex: 1; padding: 13px; border-radius: var(--radius-sm); font-weight: 500; }
    .modal-btn.secondary { background: var(--accent-soft); color: var(--text-primary); }
    .modal-btn.secondary:hover { background: var(--border); }

    .pin-input-container { display: flex; gap: 12px; justify-content: center; margin: 20px 0; }
    .pin-digit {
      width: 52px; height: 60px; font-size: 24px; text-align: center;
      border: 1px solid var(--border); border-radius: var(--radius-sm);
      background: var(--accent-soft); font-family: inherit; font-weight: 600;
      transition: all var(--transition);
    }
    .pin-digit:focus { border-color: var(--pink); background: #FFF; outline: none; box-shadow: 0 0 0 3px rgba(214,64,112,0.15); }

    /* ---- Admin ---- */
    .admin-badge {
      position: fixed; top: 10px; right: 10px; background: var(--red); color: #FFF;
      padding: 4px 10px; font-size: 10px; font-weight: 600; border-radius: var(--radius-sm);
      display: none; z-index: 2000; letter-spacing: 0.05em;
    }
    body.admin-mode .admin-badge { display: block; }

    /* ---- Toast ---- */
    .toast {
      position: fixed; bottom: 30px; left: 50%;
      transform: translateX(-50%) translateY(16px);
      background: var(--accent); color: #FFF;
      padding: 14px 28px; border-radius: var(--radius-pill);
      opacity: 0; pointer-events: none; transition: all 0.35s var(--ease);
      z-index: 1000; max-width: calc(100% - 32px); text-align: center;
      overflow-wrap: anywhere; font-size: 14px; font-weight: 500;
      box-shadow: 0 8px 32px rgba(0,0,0,0.18);
    }
    .toast.active { opacity: 1; transform: translateX(-50%) translateY(0); }

    /* ---- Group Gift Item ---- */
    .item.group-gift-item { border-left: 4px solid var(--pink); }

    /* ---- Responsive ---- */
    @media (max-width: 600px) {
      .wrap { padding: 24px 16px 60px; }
      .hero { height: 240px; }
      .hero-overlay { padding: 28px 20px 20px; }
      .hero-overlay h1 { font-size: 26px; }
      .item {
        flex-direction: column; align-items: stretch; gap: 14px;
      }
      .item-image, .item-image-placeholder {
        width: 100%; height: 180px; border-radius: var(--radius-sm);
      }
      .item-actions {
        min-width: unset;
      }
      .item-actions button { width: 100%; }
      .filter-row { flex-direction: column; align-items: stretch; }
      .sort-select { width: 100%; }
    }
  </style>
</head>

<body>
  <div class="admin-badge">ADMIN</div>

  <div class="wrap">
    <div class="hero-container">
      <img src="https://drive.google.com/thumbnail?id=1WYWYZjvu1wDPXqNuzFNPFI2quZTky3q0&sz=w2000" class="hero" alt="Cover" />
      <div class="hero-overlay">
        <h1>Unsere Hochzeitswunschliste</h1>
      </div>
    </div>

    <div id="admin-dashboard" style="display:none;background:#FFF0F0;border:2px solid #D32F2F;padding:20px;margin-bottom:40px;border-radius:16px;">
      <h2 style="color:#D32F2F;margin-top:0;font-size:18px;">Admin Dashboard</h2>
      <p style="font-size:14px;color:#555;margin-bottom:15px;">Alle Reservierungen im Überblick.</p>
      <div style="overflow-x:auto;">
        <table style="width:100%;border-collapse:collapse;font-size:13px;text-align:left;">
          <thead>
            <tr style="border-bottom:1px solid #CCC;">
              <th style="padding:8px;">Geschenk</th>
              <th style="padding:8px;">PIN</th>
              <th style="padding:8px;">Menge</th>
              <th style="padding:8px;">Aktion</th>
            </tr>
          </thead>
          <tbody id="admin-list"></tbody>
        </table>
      </div>
    </div>

    <div class="progress-container" id="progress-container">
      <div class="progress-text" id="progress-text">Lade Status...</div>
      <div class="progress-track"><div class="progress-fill" id="progress-fill"></div></div>
    </div>

    <div class="group-gift">
      <h2>Sammelgeschenk – KPM Kurland</h2>
      <p>Wer sich beteiligen möchte, kann dies gerne über unseren Trauzeugen Max Tiefenbacher tun.</p>
      <div class="iban-container" onclick="app.copyIBAN()">
        <svg class="copy-icon" viewBox="0 0 24 24">
          <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path>
        </svg>
        <span>DE89 2007 0024 0191 3888 02</span>
      </div>
      <div style="font-size:13px;color:var(--text-muted);margin-top:10px;">Max Tiefenbacher</div>
    </div>

    <div style="text-align:center;color:var(--text-primary);font-size:18px;margin-bottom:24px;line-height:1.6;">
      Lieferadresse: Urte und Jens Bötel, Hinter der Kirche 12, 38312 Börßum
    </div>

    <div style="text-align:center;margin-bottom:36px;">
      <p style="font-size:16px;color:var(--text-secondary);margin:0 0 12px;">Du hast bereits reserviert und möchtest es rückgängig machen?</p>
      <button class="modal-btn secondary" style="width:auto;padding:12px 24px;border-radius:var(--radius-sm);font-size:16px;color:var(--text-secondary);" onclick="app.openReleaseModal()">Mit Code freigeben</button>
    </div>

    <div id="my-reservations-section">
      <h2>Deine Reservierungen</h2>
      <div id="my-reservations-list"></div>
    </div>

    <div class="controls">
      <div class="search-row">
        <svg class="search-icon" viewBox="0 0 24 24">
          <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zM9.5 14C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path>
        </svg>
        <input type="text" id="search-input" class="search-input" placeholder="Wunsch suchen..." />
      </div>

      <div class="filter-row">
        <div class="toggles">
          <button class="toggle-btn" id="filter-free">Nur Verfügbare</button>
          <button class="toggle-btn" id="filter-mine">Meine Reservierungen</button>
        </div>
        <select id="sort-select" class="sort-select">
          <option value="cat">Kategorie</option>
          <option value="status">Status</option>
          <option value="price_asc">Preis (aufsteigend)</option>
          <option value="price_desc">Preis (absteigend)</option>
        </select>
      </div>
    </div>

    <div id="list"><div class="empty-state">Lade Liste...</div></div>
  </div>

  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <h3 id="modalTitle"></h3>
      <div id="modalBody"></div>
      <div class="modal-actions" id="modalActions">
        <button class="modal-btn secondary" id="modalCancel">Abbrechen</button>
        <button class="modal-btn primary" id="modalConfirm">Bestätigen</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://tpfovcyqqhqlyzcopiwt.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRwZm92Y3lxcWhxbHl6Y29waXd0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyMzQ0NDgsImV4cCI6MjA4MTgxMDQ0OH0.UBAnfI_s7vQkPMDmwZHLVTYUkmZIAMvS6sK0w60Cvps";
    const ADMIN_SECRET = "CHANGE_ME_TO_A_LONG_SECRET";

    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const state = {
      coordGroups: [],
      coordMembers: [],
      gifts: [],
      reservations: [],
      contributions: [],
      allReservations: [],
      allContributions: [],
      userPins: [],
      filter: { search: "", showFreeOnly: false, showMineOnly: false },
      sort: "cat",
      categoryState: {},
      isAdmin: false
    };

    // ---------- Utils ----------
    function escapeHtml(s) {
      return String(s || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
    }

    function escapeId(s) {
      return String(s || "")
        .replace(/\\/g, "\\\\")
        .replace(/'/g, "\\'")
        .replace(/\n/g, "\\n")
        .replace(/\r/g, "\\r");
    }

    function showToast(msg) {
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.classList.add("active");
      setTimeout(() => t.classList.remove("active"), 2500);
    }

    function catKey(c) { return encodeURIComponent(String(c || "")); }

    function loadPins() {
      try { state.userPins = JSON.parse(localStorage.getItem("user_pins") || "[]"); }
      catch { state.userPins = []; }
    }

    function savePin(pin) {
      if (!state.userPins.includes(pin)) {
        state.userPins.push(pin);
        localStorage.setItem("user_pins", JSON.stringify(state.userPins));
      }
    }

    // ---------- WhatsApp ----------
    function normalizeWhatsAppLink(raw) {
      let link = String(raw || "").trim();
      if (!link) return "";
      if (link.startsWith("chat.whatsapp.com/")) link = "https://" + link;
      if (link.startsWith("www.chat.whatsapp.com/")) link = "https://" + link.replace(/^www\./, "");
      if (link.startsWith("whatsapp.com/invite/")) link = "https://www." + link;
      if (link.startsWith("www.whatsapp.com/invite/")) link = "https://" + link;
      return link.trim();
    }

    function isValidWhatsAppInvite(raw) {
      const link = normalizeWhatsAppLink(raw);
      try {
        const u = new URL(link);
        const host = u.hostname.replace(/^www\./, "");
        const path = u.pathname.replace(/\/+/g, "/");
        const isChat = host === "chat.whatsapp.com" && path.length > 2;
        const isInvite = host === "whatsapp.com" && path.startsWith("/invite/") && path.length > "/invite/".length;
        return isChat || isInvite;
      } catch {
        return false;
      }
    }

    function openWhatsApp(link) {
      const url = normalizeWhatsAppLink(link);
      if (!isValidWhatsAppInvite(url)) {
        showToast("Ungültiger WhatsApp-Link.");
        return;
      }
      window.open(url, "_blank", "noopener");
    }

    // ---------- Data helpers ----------
    function parsePrice(s) {
      if (!s) return Infinity;
      const m = String(s).match(/[\d.,]+/);
      if (!m) return Infinity;
      return parseFloat(m[0].replace(/\./g, "").replace(",", "."));
    }

    function getContributionTotal(giftId) {
      return (state.contributions || [])
        .filter(c => c.gift_id === giftId)
        .reduce((sum, c) => sum + (parseFloat(c.amount) || 0), 0);
    }

    function getAvailable(g) {
      if (g.is_group_gift) {
        const current = getContributionTotal(g.id);
        const target = parseFloat(g.target_amount) || 0;
        if (target > 0 && current >= target) return 0;
        return 1;
      }
      const q = parseInt(g.quantity) || 1;
      const r = parseInt(g.reserved_quantity) || 0;
      return Math.max(0, q - r);
    }

    function myReservationForGift(giftId) {
      const mine = (state.reservations || []).filter(r => r.gift_id === giftId && state.userPins.includes(r.pin));
      if (mine.length === 0) return null;
      const totalQty = mine.reduce((s, r) => s + (parseInt(r.qty) || 1), 0);
      return { pin: mine[0].pin, qty: totalQty, rows: mine };
    }

    function isReservedByMe(g) {
      if (g.is_group_gift) {
        return (state.contributions || []).some(c => c.gift_id === g.id && state.userPins.includes(c.pin));
      }
      return !!myReservationForGift(g.id);
    }

    // ---------- Coordination helpers ----------
    function getGroupForGift(giftId) {
      return (state.coordGroups || []).find(gr => gr.gift_id === giftId) || null;
    }

    function getMemberPinsForGroup(groupId) {
      const pins = (state.coordMembers || [])
        .filter(m => m.group_id === groupId)
        .map(m => String(m.pin || "").trim())
        .filter(Boolean);
      return Array.from(new Set(pins));
    }

    function getMemberCount(groupId) {
      return getMemberPinsForGroup(groupId).length;
    }

    // ---------- Modal helpers ----------
    function confirmModal(title, text) {
      return new Promise(resolve => {
        const el = document.getElementById("modalOverlay");
        document.getElementById("modalTitle").textContent = title;
        document.getElementById("modalBody").innerHTML = `<p>${text}</p>`;

        const actions = document.getElementById("modalActions");
        actions.style.display = "flex";

        const ok = document.getElementById("modalConfirm");
        ok.textContent = "Ja";
        ok.disabled = false;

        const close = (v) => { el.classList.remove("active"); resolve(v); };
        ok.onclick = () => close(true);
        document.getElementById("modalCancel").onclick = () => close(false);

        el.classList.add("active");
      });
    }

    function requestPin(title, txt) {
      return new Promise(resolve => {
        const html = `<p>${txt}</p>
          <div class="pin-input-container">
            <input class="pin-digit" type="tel" inputmode="numeric" maxlength="1">
            <input class="pin-digit" type="tel" inputmode="numeric" maxlength="1">
            <input class="pin-digit" type="tel" inputmode="numeric" maxlength="1">
            <input class="pin-digit" type="tel" inputmode="numeric" maxlength="1">
          </div>`;

        const el = document.getElementById("modalOverlay");
        document.getElementById("modalTitle").textContent = title;
        document.getElementById("modalBody").innerHTML = html;

        const actions = document.getElementById("modalActions");
        actions.style.display = "flex";

        const btn = document.getElementById("modalConfirm");
        btn.textContent = "Bestätigen";
        btn.disabled = true;

        const inputs = el.querySelectorAll(".pin-digit");

        const check = () => {
          const code = Array.from(inputs).map(x => x.value).join("");
          btn.disabled = code.length !== 4;
          return code;
        };

        inputs.forEach((inp, i) => {
          inp.value = "";
          inp.oninput = () => {
            if (!/^\d$/.test(inp.value)) inp.value = "";
            if (inp.value && i < 3) inputs[i + 1].focus();
            check();
          };
          inp.onkeydown = (e) => {
            if (e.key === "Backspace" && !inp.value && i > 0) inputs[i - 1].focus();
          };
        });

        const close = (val) => { el.classList.remove("active"); resolve(val); };
        btn.onclick = () => close(check());
        document.getElementById("modalCancel").onclick = () => close(null);

        el.classList.add("active");
        setTimeout(() => inputs[0].focus(), 100);
      });
    }

    function requestReservationInput(title, txt, maxQty) {
      return new Promise(resolve => {
        const safeMax = Math.max(1, parseInt(maxQty || 1, 10));
        const options = Array.from({ length: safeMax }, (_, i) => {
          const v = i + 1;
          return `<option value="${v}">${v}</option>`;
        }).join("");

        const qtyBlock = safeMax > 1 ? `
          <div style="text-align:left;margin-top:10px;">
            <label style="display:block;font-size:13px;margin-bottom:4px;color:#666;">Menge</label>
            <select id="inp-qty" style="width:100%;padding:10px;border:1px solid #CCC;border-radius:8px;font-size:16px;">
              ${options}
            </select>
            <div style="font-size:12px;color:#888;margin-top:6px;">Maximal ${safeMax} verfügbar</div>
          </div>
        ` : `<input type="hidden" id="inp-qty" value="1">`;

        const html = `
          <p>${txt}</p>
          <div class="pin-input-container">
            <input class="pin-digit" type="tel" inputmode="numeric" maxlength="1">
            <input class="pin-digit" type="tel" inputmode="numeric" maxlength="1">
            <input class="pin-digit" type="tel" inputmode="numeric" maxlength="1">
            <input class="pin-digit" type="tel" inputmode="numeric" maxlength="1">
          </div>
          ${qtyBlock}
        `;

        const el = document.getElementById("modalOverlay");
        document.getElementById("modalTitle").textContent = title;
        document.getElementById("modalBody").innerHTML = html;

        const actions = document.getElementById("modalActions");
        actions.style.display = "flex";

        const btn = document.getElementById("modalConfirm");
        btn.textContent = "Reservieren";
        btn.disabled = true;

        const inputs = el.querySelectorAll(".pin-digit");
        const qtyEl = document.getElementById("inp-qty");

        const check = () => {
          const code = Array.from(inputs).map(x => x.value).join("");
          const qty = Math.max(1, Math.min(safeMax, parseInt(qtyEl.value || "1", 10) || 1));
          btn.disabled = code.length !== 4;
          return { pin: code, qty };
        };

        inputs.forEach((inp, i) => {
          inp.value = "";
          inp.oninput = () => {
            if (!/^\d$/.test(inp.value)) inp.value = "";
            if (inp.value && i < 3) inputs[i + 1].focus();
            check();
          };
          inp.onkeydown = (e) => {
            if (e.key === "Backspace" && !inp.value && i > 0) inputs[i - 1].focus();
          };
        });

        if (qtyEl) qtyEl.onchange = check;

        const close = (val) => { el.classList.remove("active"); resolve(val); };
        btn.onclick = () => close(check());
        document.getElementById("modalCancel").onclick = () => close(null);

        el.classList.add("active");
        setTimeout(() => inputs[0].focus(), 100);
      });
    }

    function requestContributionInput(giftTitle) {
      return new Promise(resolve => {
        const el = document.getElementById("modalOverlay");
        document.getElementById("modalTitle").textContent = "Beteiligen an: " + giftTitle;

        const html = `
          <div style="text-align:left; margin-bottom:20px;">
            <label style="display:block; font-size:13px; margin-bottom:4px; color:#666;">Betrag (€)</label>
            <input type="number" id="inp-amount" style="width:100%; padding:10px; border:1px solid #CCC; border-radius:8px; font-size:16px; margin-bottom:12px;" placeholder="z.B. 50">
            <label style="display:block; font-size:13px; margin-bottom:4px; color:#666;">Name (optional)</label>
            <input type="text" id="inp-name" style="width:100%; padding:10px; border:1px solid #CCC; border-radius:8px; font-size:16px; margin-bottom:12px;" placeholder="Dein Name">
            <label style="display:block; font-size:13px; margin-bottom:4px; color:#666;">Nachricht (optional)</label>
            <textarea id="inp-msg" style="width:100%; padding:10px; border:1px solid #CCC; border-radius:8px; font-size:14px; resize:none; margin-bottom:12px;" rows="2" placeholder="Deine Nachricht an das Brautpaar..."></textarea>
            <label style="display:block; font-size:13px; margin-bottom:4px; color:#666;">Dein PIN (4-stellig)</label>
            <div class="pin-input-container" style="justify-content:flex-start; margin:0;">
              <input class="pin-digit" type="tel" inputmode="numeric" maxlength="1">
              <input class="pin-digit" type="tel" inputmode="numeric" maxlength="1">
              <input class="pin-digit" type="tel" inputmode="numeric" maxlength="1">
              <input class="pin-digit" type="tel" inputmode="numeric" maxlength="1">
            </div>
          </div>
        `;

        document.getElementById("modalBody").innerHTML = html;

        const actions = document.getElementById("modalActions");
        actions.style.display = "flex";

        const btn = document.getElementById("modalConfirm");
        btn.textContent = "Speichern";
        btn.disabled = true;

        const inputs = el.querySelectorAll(".pin-digit");
        const amountInp = document.getElementById("inp-amount");

        const check = () => {
          const code = Array.from(inputs).map(x => x.value).join("");
          const amt = parseFloat(amountInp.value);
          btn.disabled = code.length !== 4 || isNaN(amt) || amt <= 0;

          return {
            amount: amt,
            name: document.getElementById("inp-name").value,
            message: document.getElementById("inp-msg").value,
            pin: code
          };
        };

        amountInp.oninput = check;

        inputs.forEach((inp, i) => {
          inp.value = "";
          inp.oninput = () => {
            if (!/^\d$/.test(inp.value)) inp.value = "";
            if (inp.value && i < 3) inputs[i + 1].focus();
            check();
          };
          inp.onkeydown = (e) => {
            if (e.key === "Backspace" && !inp.value && i > 0) inputs[i - 1].focus();
          };
        });

        const close = (val) => { el.classList.remove("active"); resolve(val); };
        btn.onclick = () => close(check());
        document.getElementById("modalCancel").onclick = () => close(null);

        el.classList.add("active");
        setTimeout(() => amountInp.focus(), 100);
      });
    }

    // ---------- App ----------
    window.app = {
      toggleCat: (k) => { state.categoryState[k] = !state.categoryState[k]; render(); },

      copyIBAN: () => navigator.clipboard
        .writeText("DE89200700240191388802")
        .then(() => showToast("IBAN kopiert"))
        .catch(() => showToast("IBAN kopiert")),

      reserve: async (id) => {
        const g = state.gifts.find(x => x.id === id);
        if (!g) return;
        if (getAvailable(g) < 1) { showToast("Nicht mehr verfügbar."); return; }

        const { data: fresh, error: fErr } = await sb.from("gifts").select("quantity, reserved_quantity").eq("id", id).single();
        if (fErr || !fresh) { showToast("Fehler beim Prüfen."); return; }

        const availableNow = Math.max(0, (parseInt(fresh.quantity) || 1) - (parseInt(fresh.reserved_quantity) || 0));
        if (availableNow < 1) { showToast("Leider war jemand schneller."); await loadData(); return; }

        const input = await requestReservationInput(
          "Wunsch reservieren",
          "Bitte wähle einen persönlichen 4-stelligen Code und merke dir diesen! Mit diesem Code kannst du deine Reservierung später wieder ändern oder freigeben.",
          availableNow
        );
        if (!input) return;

        const pin = input.pin;
        const qtyWanted = Math.max(1, Math.min(availableNow, parseInt(input.qty || 1, 10) || 1));

        const { data: existingRows, error: exErr } = await sb
          .from("reservations")
          .select("id, qty")
          .match({ gift_id: id, pin: pin });

        if (exErr) { showToast("Fehler beim Prüfen."); return; }

        const existing = (existingRows && existingRows.length > 0) ? existingRows[0] : null;
        const existingQty = existing ? (parseInt(existing.qty) || 1) : 0;

        const { data: fresh2, error: fErr2 } = await sb.from("gifts").select("quantity, reserved_quantity").eq("id", id).single();
        if (fErr2 || !fresh2) { showToast("Fehler beim Prüfen."); return; }

        const availableNow2 = Math.max(0, (parseInt(fresh2.quantity) || 1) - (parseInt(fresh2.reserved_quantity) || 0));
        if (availableNow2 < 1) { showToast("Leider war jemand schneller."); await loadData(); return; }

        const qtyFinal = Math.max(1, Math.min(availableNow2, qtyWanted));

        if (existing) {
          const newExistingQty = existingQty + qtyFinal;

          const { error: upErr } = await sb
            .from("reservations")
            .update({ qty: newExistingQty })
            .eq("id", existing.id);

          if (upErr) { showToast("Fehler beim Speichern."); return; }
        } else {
          const { error: insErr } = await sb
            .from("reservations")
            .insert({ gift_id: id, pin: pin, qty: qtyFinal });

          if (insErr) {
            if (insErr.code === "23505") showToast("PIN bereits vergeben. Bitte anderen Code wählen.");
            else showToast("Fehler beim Speichern.");
            return;
          }
        }

        const newQ = (parseInt(fresh2.reserved_quantity) || 0) + qtyFinal;
        await sb.from("gifts").update({ reserved_quantity: newQ }).eq("id", id);

        savePin(pin);
        showToast("Reserviert!");
        await loadData();
      },

      unreserve: async (id) => {
        const mine = (state.reservations || []).filter(r => r.gift_id === id && state.userPins.includes(r.pin));
        if (mine.length === 0) return;

        const pin = mine[0].pin;
        const totalQty = mine.reduce((s, r) => s + (parseInt(r.qty) || 1), 0);

        if (!(await confirmModal("Freigeben?", "Möchtest du diese Reservierung freigeben?"))) return;

        const { error: delErr } = await sb.from("reservations").delete().match({ gift_id: id, pin: pin });
        if (delErr) { showToast("Fehler beim Löschen."); return; }

        const { data: fresh } = await sb.from("gifts").select("reserved_quantity").eq("id", id).single();
        if (fresh) {
          const newQ = Math.max(0, (parseInt(fresh.reserved_quantity) || 0) - totalQty);
          await sb.from("gifts").update({ reserved_quantity: newQ }).eq("id", id);
        }

        showToast("Freigegeben.");
        await loadData();
      },

      contribute: async (id) => {
        const g = state.gifts.find(x => x.id === id);
        if (!g) return;

        const input = await requestContributionInput(g.title);
        if (!input) return;

        const { amount, name, message, pin } = input;
        const { error } = await sb.from("contributions").insert({ gift_id: id, amount, name, message, pin });
        if (error) { showToast("Fehler beim Speichern."); return; }

        savePin(pin);
        showToast("Beitrag gespeichert!");
        await loadData();
      },

      removeContribution: async (id) => {
        const myContribs = (state.contributions || []).filter(c => c.gift_id === id && state.userPins.includes(c.pin));
        if (myContribs.length === 0) return;

        const c = myContribs[myContribs.length - 1];
        if (!(await confirmModal("Beitrag zurückziehen?", `Deinen Beitrag von ${c.amount}€ entfernen?`))) return;

        const { error } = await sb.from("contributions").delete().eq("id", c.id);
        if (error) { showToast("Fehler beim Entfernen."); return; }

        showToast("Entfernt.");
        await loadData();
      },

      openReleaseModal: async () => {
        const pin = await requestPin("Reservierung finden", "Bitte gib deinen Code ein.");
        if (!pin) return;

        const { data: list } = await sb.from("reservations").select("*, gifts(title)").eq("pin", pin);
        const { data: cList } = await sb.from("contributions").select("*, gifts(title)").eq("pin", pin);

        const hasRes = list && list.length > 0;
        const hasCon = cList && cList.length > 0;

        if (!hasRes && !hasCon) {
          showToast("Keine Einträge gefunden.");
          return;
        }

        if (hasRes && list.length > 1) {
          const el = document.getElementById("modalOverlay");
          document.getElementById("modalTitle").textContent = "Mehrere Reservierungen gefunden";
          const body = list.map(r => {
            const title = r.gifts ? r.gifts.title : "Unbekannt";
            const qty = parseInt(r.qty) || 1;
            return `<button style="width:100%;margin-top:8px" onclick="app._releaseReservationById('${r.id}','${r.gift_id}',${qty})">
              ${escapeHtml(title)} (${qty}x) freigeben
            </button>`;
          }).join("");

          document.getElementById("modalBody").innerHTML = `<p>Bitte auswählen:</p>${body}`;

          const actions = document.getElementById("modalActions");
          actions.style.display = "none";

          el.classList.add("active");
          document.getElementById("modalCancel").onclick = () => { el.classList.remove("active"); };

          savePin(pin);
          return;
        }

        if (hasRes) {
          const item = list[0];
          const title = item.gifts ? item.gifts.title : "Unbekannt";
          const qty = parseInt(item.qty) || 1;

          if (!(await confirmModal("Gefunden", `Freigeben: "${escapeHtml(title)}" (${qty}x)?`))) return;

          await sb.from("reservations").delete().eq("id", item.id);
          const { data: g } = await sb.from("gifts").select("reserved_quantity").eq("id", item.gift_id).single();
          if (g) {
            await sb.from("gifts").update({
              reserved_quantity: Math.max(0, (parseInt(g.reserved_quantity) || 0) - qty)
            }).eq("id", item.gift_id);
          }
        } else if (hasCon) {
          const item = cList[0];
          const title = item.gifts ? item.gifts.title : "Unbekannt";
          if (!(await confirmModal("Beitrag gefunden", `Beitrag für "${escapeHtml(title)}" (${item.amount}€) entfernen?`))) return;
          await sb.from("contributions").delete().eq("id", item.id);
        }

        savePin(pin);
        showToast("Erledigt.");
        await loadData();
      },

      _releaseReservationById: async (resId, giftId, qty) => {
        const el = document.getElementById("modalOverlay");
        el.classList.remove("active");

        if (!(await confirmModal("Freigeben?", "Möchtest du diese Reservierung freigeben?"))) return;

        const { error: delErr } = await sb.from("reservations").delete().eq("id", resId);
        if (delErr) { showToast("Fehler beim Löschen."); return; }

        const { data: g } = await sb.from("gifts").select("reserved_quantity").eq("id", giftId).single();
        if (g) {
          await sb.from("gifts").update({
            reserved_quantity: Math.max(0, (parseInt(g.reserved_quantity) || 0) - (parseInt(qty) || 1))
          }).eq("id", giftId);
        }

        showToast("Freigegeben.");
        await loadData();
      },

      adminDelete: async (resId, giftId, qty, isContribution = false) => {
        if (!(await confirmModal("ADMIN LÖSCHEN", "Wirklich löschen?"))) return;

        const table = isContribution ? "contributions" : "reservations";
        const { error } = await sb.from(table).delete().eq("id", resId);
        if (error) { showToast("Fehler."); return; }

        if (!isContribution) {
          const { data: fresh } = await sb.from("gifts").select("reserved_quantity").eq("id", giftId).single();
          if (fresh) {
            const newQ = Math.max(0, (parseInt(fresh.reserved_quantity) || 0) - (parseInt(qty) || 1));
            await sb.from("gifts").update({ reserved_quantity: newQ }).eq("id", giftId);
          }
        }

        showToast("Gelöscht.");
        await loadData();
      },

      adminReset: async (id) => {
        if (!(await confirmModal("ADMIN", "Reset completely?"))) return;
        await sb.from("reservations").delete().eq("gift_id", id);
        await sb.from("gifts").update({ reserved_quantity: 0, reserved: false }).eq("id", id);
        await loadData();
      },

      createCoordination: async (giftId) => {
        const existing = getGroupForGift(giftId);
        if (existing) {
          showToast("Für dieses Geschenk gibt es bereits eine Organisation.");
          return;
        }

        const pin = await requestPin("Organisation übernehmen", "Bitte lege einen 4-stelligen Code fest.");
        if (!pin) return;

        const linkRaw = prompt("WhatsApp Gruppenlink einfügen:") || "";
        const link = normalizeWhatsAppLink(linkRaw);

        if (!isValidWhatsAppInvite(link)) {
          showToast("Ungültiger WhatsApp Gruppenlink. Bitte direkt aus WhatsApp kopieren.");
          return;
        }

        const max = parseInt(prompt("Maximale Teilnehmerzahl? (z.B. 3)"), 10);
        if (!max || max < 2) { showToast("Ungültige Anzahl."); return; }

        const { data: created, error } = await sb
          .from("gift_coordination_groups")
          .insert({ gift_id: giftId, creator_pin: pin, whatsapp_link: link, max_members: max })
          .select("*")
          .single();

        if (error || !created) {
          console.error(error);
          showToast("Fehler beim Anlegen.");
          return;
        }

        const { error: mErr } = await sb
          .from("gift_coordination_members")
          .insert({ group_id: created.id, pin: pin });

        if (mErr) console.warn("Member insert failed (check columns/RLS):", mErr);

        savePin(pin);
        showToast("Organisation angelegt.");
        await loadData();
      },

      joinCoordination: async (groupId) => {
        const group = (state.coordGroups || []).find(g => g.id === groupId);
        if (!group) { showToast("Gruppe nicht gefunden."); return; }

        const currentPins = getMemberPinsForGroup(groupId);
        const max = parseInt(group.max_members) || 0;

        if (max > 0 && currentPins.length >= max) {
          showToast("Diese Organisation ist bereits voll.");
          return;
        }

        const pin = await requestPin("An Gruppengeschenk beteiligen", "Bitte gib einen 4-stelligen Code ein.");
        if (!pin) return;

        if (!currentPins.includes(pin)) {
          const { error } = await sb
            .from("gift_coordination_members")
            .insert({ group_id: groupId, pin: pin });

          if (error) {
            console.warn("Join insert failed (check columns/RLS):", error);
          }
        }

        savePin(pin);
        openWhatsApp(group.whatsapp_link);
        await loadData();
      }
    };

    // ---------- Load + Render ----------
    async function loadData() {
      const params = new URLSearchParams(window.location.search);
      if (params.get("admin") === ADMIN_SECRET || window.location.hash.includes("master") || window.location.href.includes("/master")) {
        state.isAdmin = true;
        document.body.classList.add("admin-mode");
      }

      loadPins();

      const { data: gs, error: gErr } = await sb.from("gifts").select("*").order("category").order("title");
      if (gErr) {
        document.getElementById("list").innerHTML = `<div class="empty-state">Fehler beim Laden.</div>`;
        return;
      }
      state.gifts = gs || [];

      try {
        const { data: groups, error: ggErr } = await sb.from("gift_coordination_groups").select("*");
        if (ggErr) throw ggErr;

        const { data: members, error: gmErr } = await sb.from("gift_coordination_members").select("*");
        if (gmErr) throw gmErr;

        state.coordGroups = groups || [];
        state.coordMembers = members || [];
      } catch (e) {
        console.warn("Coord tables missing / RLS / error:", e);
        state.coordGroups = [];
        state.coordMembers = [];
      }

      try {
        const { data: contribs, error: cErr } = await sb.from("contributions").select("*");
        if (cErr) throw cErr;
        state.contributions = contribs || [];
      } catch (e) {
        console.warn("Contributions missing / RLS / error:", e);
        state.contributions = [];
      }

      if (state.isAdmin) {
        const { data: allRes } = await sb.from("reservations").select("*, gifts(title)").order("created_at", { ascending: false });
        const { data: allContribs } = await sb.from("contributions").select("*, gifts(title)").order("created_at", { ascending: false });

        state.allReservations = allRes || [];
        state.allContributions = allContribs || [];

        document.getElementById("admin-dashboard").style.display = "block";
        renderAdmin();

        state.reservations = allRes || [];
      } else {
        if (state.userPins.length > 0) {
          const { data: rs } = await sb.from("reservations").select("*").in("pin", state.userPins);
          state.reservations = rs || [];
        } else {
          state.reservations = [];
        }
      }

      render();
    }

    function renderAdmin() {
      const list = document.getElementById("admin-list");
      let html = "";

      if (state.allReservations.length > 0) {
        html += `<tr style="background:#EEE"><td colspan="4" style="padding:4px 8px; font-weight:600;">Reservierungen</td></tr>`;
        html += state.allReservations.map(r => {
          const title = r.gifts ? r.gifts.title : "???";
          const qty = parseInt(r.qty) || 1;
          return `<tr style="border-bottom:1px solid #EEE;">
            <td style="padding:8px; font-weight:500;">${escapeHtml(title)}</td>
            <td style="padding:8px; font-family:monospace;">${escapeHtml(r.pin)}</td>
            <td style="padding:8px;">${qty}x</td>
            <td style="padding:8px;">
              <button style="background:#FFF0F0; color:#D32F2F; border:1px solid #D32F2F; padding:4px 10px; font-size:11px; border-radius:6px;"
                onclick="app.adminDelete('${r.id}', '${r.gift_id}', ${qty})">Löschen</button>
            </td>
          </tr>`;
        }).join("");
      }

      if (state.allContributions.length > 0) {
        html += `<tr style="background:#EEE"><td colspan="4" style="padding:4px 8px; font-weight:600;">Beiträge (Gruppe)</td></tr>`;
        html += state.allContributions.map(c => {
          const title = c.gifts ? c.gifts.title : "???";
          const msg = c.message ? `<div style="font-size:10px;color:#666;max-width:200px;text-overflow:ellipsis;overflow:hidden;white-space:nowrap;">"${escapeHtml(c.message)}"</div>` : "";
          return `<tr style="border-bottom:1px solid #EEE;">
            <td style="padding:8px; font-weight:500;">${escapeHtml(title)}<br><span style="font-size:11px;color:#555">${escapeHtml(c.name || "-")}</span></td>
            <td style="padding:8px; font-family:monospace;">${escapeHtml(c.pin)}</td>
            <td style="padding:8px;">${c.amount}€</td>
            <td style="padding:8px;">
              ${msg}
              <button style="background:#FFF0F0; color:#D32F2F; border:1px solid #D32F2F; padding:4px 10px; font-size:11px; border-radius:6px;"
                onclick="app.adminDelete('${c.id}', '${c.gift_id}', 0, true)">Löschen</button>
            </td>
          </tr>`;
        }).join("");
      }

      if (!html) html = `<tr><td colspan="4" style="padding:15px;text-align:center;">Keine Einträge.</td></tr>`;
      list.innerHTML = html;
    }

    function render() {
      const total = state.gifts.length;

      const fulfilled = state.gifts.filter(g => {
        if (g.is_group_gift) {
          const target = parseFloat(g.target_amount) || 1;
          return getContributionTotal(g.id) >= target;
        }
        return getAvailable(g) === 0;
      }).length;

      document.getElementById("progress-fill").style.width = (total > 0 ? (fulfilled / total) * 100 : 0) + "%";
      document.getElementById("progress-text").textContent = `${fulfilled} von ${total} Wünschen erfüllt`;

      const sLower = (state.filter.search || "").toLowerCase();

      const filtered = state.gifts.filter(g => {
        const title = (g.title || "").toLowerCase();
        const has = title.includes(sLower);
        const my = isReservedByMe(g);

        if (state.filter.showFreeOnly) {
          if (g.is_group_gift) {
            const target = parseFloat(g.target_amount) || 1;
            if (getContributionTotal(g.id) >= target) return false;
          } else {
            if (getAvailable(g) === 0) return false;
          }
        }

        if (state.filter.showMineOnly && !my) return false;
        return has;
      });

      filtered.sort((a, b) => {
        if (state.sort.includes("price")) {
          const pa = parsePrice(a.Preis), pb = parsePrice(b.Preis);
          return state.sort === "price_asc" ? pa - pb : pb - pa;
        }
        if (state.sort === "status") {
          const aa = getAvailable(a) > 0, bb = getAvailable(b) > 0;
          if (aa === bb) return (a.title || "").localeCompare(b.title || "");
          return aa ? -1 : 1;
        }
        if ((a.category || "") !== (b.category || "")) return (a.category || "").localeCompare(b.category || "");
        return (a.title || "").localeCompare(b.title || "");
      });

      let html = "";
      const cats = {};

      if (state.sort === "cat") {
        filtered.forEach(g => (cats[g.category] ||= []).push(g));

        for (const c in cats) {
          const key = catKey(c);
          const open = !state.categoryState[key];

          html += `
            <div class="section-title ${!open ? "collapsed" : ""}" onclick="app.toggleCat('${key}')">
              <h2>${escapeHtml(c)}</h2>
              <svg class="section-chevron" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
            </div>
            <div class="gift-group ${!open ? "collapsed" : ""}">
              ${cats[c].map(g => renderItem(g, false)).join("")}
            </div>
          `;
        }
      } else {
        html = filtered.map(g => renderItem(g, false)).join("");
      }

      if (!html) html = `<div class="empty-state">Nichts gefunden.</div>`;
      document.getElementById("list").innerHTML = html;

      const mine = state.gifts.filter(g => isReservedByMe(g));
      const mySec = document.getElementById("my-reservations-section");

      if (mine.length > 0) {
        mySec.style.display = "block";
        document.getElementById("my-reservations-list").innerHTML = mine.map(g => renderItem(g, true)).join("");
      } else {
        mySec.style.display = "none";
      }
    }

    // ---------- Image helper ----------
    window.handleImgError = function(img) {
      const placeholder = document.createElement('div');
      placeholder.className = 'item-image-placeholder';
      placeholder.innerHTML = '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>';
      img.replaceWith(placeholder);
    };

    function renderImageBlock(g) {
      if (g.image_url) {
        return `<img class="item-image" src="${escapeHtml(g.image_url)}" alt="${escapeHtml(g.title)}" loading="lazy" onerror="handleImgError(this)" />`;
      }
      return "";
    }

    function renderItem(g, isMySection = false) {
      const inMySection = (isMySection === true);

      if (g.is_group_gift) return renderGroupGiftItem(g, inMySection);

      const avail = getAvailable(g);
      const myRes = myReservationForGift(g.id);
      const my = !!myRes;
      const hasImage = !!g.image_url;

      const price = g.Preis ? `<span style="font-weight:500;">${escapeHtml(g.Preis)}</span><div class="sep"></div>` : "";

      let act = "";
      if (avail > 0) act = `<button onclick="app.reserve('${escapeId(g.id)}')">Reservieren</button>`;
      else if (my) act = `<button class="reserved" onclick="app.unreserve('${escapeId(g.id)}')">Meine Reservierung</button>`;
      else act = `<button disabled>Vergeben</button>`;

      if (inMySection) act = `<button class="undo" onclick="app.unreserve('${escapeId(g.id)}')">Freigeben</button>`;

      let st = "";
      const qty = parseInt(g.quantity) || 1;

      if (myRes && (parseInt(myRes.qty) || 0) > 0) {
        st += `<div style="color:var(--text-secondary);font-size:12px;margin-top:6px;">Du hast ${parseInt(myRes.qty)} reserviert</div>`;
      }

      if (qty > 1) {
        if (avail === 0) st += `<div style="color:var(--red);font-size:12px;">Alle ${qty} vergeben</div>`;
        else st += `<div style="color:var(--green);font-size:12px;">${avail} von ${qty} verfügbar</div>`;
      }

      let coordUI = "";
      const group = getGroupForGift(g.id);

      const isGiftReserved =
        (parseInt(g.reserved_quantity || 0) > 0) ||
        (getAvailable(g) === 0);

      if (!g.is_group_gift && g.allow_coordination && !isGiftReserved) {
        if (!group) {
          coordUI = `
            <button class="reserved" style="font-size:11px"
              onclick="app.createCoordination('${escapeId(g.id)}')">
              Organisation eines Gruppengeschenkes übernehmen
            </button>
          `;
        } else {
          const count = getMemberCount(group.id);
          coordUI = `
            <a href="${escapeHtml(group.whatsapp_link)}"
               target="_blank"
               rel="noopener"
               style="font-size:11px;color:var(--text-muted);text-decoration:underline">
              An Gruppengeschenk beteiligen (${count}/${group.max_members})
            </a>
          `;
        }
      }

      const admin = state.isAdmin
        ? `<div style="margin-top:5px"><button style="background:black;color:white;padding:4px 8px;font-size:10px" onclick="app.adminReset('${escapeId(g.id)}')">RESET GIFT</button></div>`
        : "";

      return `
        <div class="item ${my ? "my-reservation" : ""}">
          ${renderImageBlock(g)}
          <div class="item-content">
            <div class="item-title">${escapeHtml(g.title)}</div>
            <div class="meta">${price}<a href="${escapeHtml(g.url)}" target="_blank" rel="noopener">Zum Shop &#8599;</a></div>
            ${st}
          </div>
          <div class="item-actions">
            ${act}
            ${coordUI}
            ${admin}
          </div>
        </div>
      `;
    }

    function renderGroupGiftItem(g, isMySection = false) {
      const inMySection = (isMySection === true);

      const current = getContributionTotal(g.id);
      const target = parseFloat(g.target_amount) || 1;
      const percent = Math.min(100, (current / target) * 100);

      const bar = `
        <div style="margin-top:10px;">
          <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text-secondary);margin-bottom:4px;">
            <span>${current}€ gesammelt</span>
            <span>Ziel: ${target}€</span>
          </div>
          <div style="height:5px;background:var(--border);border-radius:4px;overflow:hidden;">
            <div style="height:100%;width:${percent}%;background:var(--green);border-radius:4px;transition:width 0.8s var(--ease);"></div>
          </div>
        </div>
      `;

      let act = `<button style="background:var(--green);" onclick="app.contribute('${escapeId(g.id)}')">Beteiligen</button>`;
      if (inMySection) act = `<button class="undo" onclick="app.removeContribution('${escapeId(g.id)}')">Beitrag zurückziehen</button>`;

      const priceStr = g.Preis ? `<span style="font-weight:500;">${escapeHtml(g.Preis)} (Ziel)</span><div class="sep"></div>` : "";

      return `
        <div class="item group-gift-item ${isReservedByMe(g) ? "my-reservation" : ""}">
          ${renderImageBlock(g)}
          <div class="item-content">
            <div class="item-title">
              ${escapeHtml(g.title)}
              <span style="font-size:11px;font-weight:500;color:var(--green);background:var(--green-bg);padding:2px 8px;border-radius:var(--radius-pill);margin-left:6px;white-space:nowrap;">Sammelgeschenk</span>
            </div>
            <div class="meta">${priceStr}<a href="${escapeHtml(g.url)}" target="_blank" rel="noopener">Details &#8599;</a></div>
            ${bar}
          </div>
          <div class="item-actions">
            ${act}
          </div>
        </div>
      `;
    }

    // Controls
    document.getElementById("search-input").oninput = (e) => { state.filter.search = e.target.value; render(); };
    document.getElementById("filter-free").onclick = (e) => {
      state.filter.showFreeOnly = !state.filter.showFreeOnly;
      e.target.classList.toggle("active", state.filter.showFreeOnly);
      render();
    };
    document.getElementById("filter-mine").onclick = (e) => {
      state.filter.showMineOnly = !state.filter.showMineOnly;
      e.target.classList.toggle("active", state.filter.showMineOnly);
      render();
    };
    document.getElementById("sort-select").onchange = (e) => { state.sort = e.target.value; render(); };

    // Start
    loadData();
  </script>
</body>
</html>
