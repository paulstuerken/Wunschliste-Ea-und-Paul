<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Unsere Wunschliste</title>
  <style>
    body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial;
  background: #f7f6f3;
  color: #2b2b2b;
}
    .wrap { max-width: 800px; margin: 40px auto; padding: 0 16px; }
    h1 { font-size: 22px; }
    h2 { font-size: 16px; margin-top: 30px; }
    .item { border:1px solid #eee; border-radius:10px; padding:12px; margin:10px 0; display:flex; justify-content:space-between; align-items:center; gap:12px; }
    a { color:#111; }
    button { background:#111; color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
    button[disabled] { opacity:.4; cursor:not-allowed; }
    .status { font-size:12px; color:#555; margin-top:6px; }
  </style>
</head>
<body>
<div class="wrap">
  <h1>Wunschliste von Ea und Paul</h1>
  <p>Falls ihr uns etwas schenken möchtet, freuen wir uns sehr über einen Blick auf diese Liste.
Die Geschenke können natürlich ganz frei ausgewählt und gekauft werden.
Wenn ihr euch für etwas entscheidet, könnt ihr es hier gern als reserviert markieren, damit es nicht doppelt verschenkt wird.</p>

  <div id="list">Lade Liste…</div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

const SUPABASE_URL = "https://tpfovcyqqhqlyzcopiwt.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRwZm92Y3lxcWhxbHl6Y29waXd0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyMzQ0NDgsImV4cCI6MjA4MTgxMDQ0OH0.UBAnfI_s7vQkPMDmwZHLVTYUkmZIAMvS6sK0w60Cvps";

const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const list = document.getElementById("list");

async function load() {
  const { data, error } = await sb.from("gifts").select("*").order("category").order("title");
  if (error) { list.textContent = "Fehler beim Laden"; console.error(error); return; }
  if (!data || data.length === 0) { list.textContent = "Noch keine Geschenke eingetragen."; return; }

  const cats = {};
  data.forEach(g => (cats[g.category] ??= []).push(g));

  let html = "";
  Object.keys(cats).forEach(c => {
    html += `<h2>${c}</h2>`;
    cats[c].forEach(g => {
      html += `
        <div class="item">
          <div>
            <div>${g.title}</div>
            <a href="${g.url}" target="_blank" rel="noopener">zum Shop</a>
            <div class="status">${g.reserved ? "reserviert" : "frei"}</div>
          </div>
          ${(() => {
  const myToken = getLocalToken(g.id);
  const reservedByMe =
    g.reserved &&
    g.reserved_token &&
    myToken &&
    g.reserved_token === myToken;

  if (!g.reserved) {
    return `<button onclick="reserveGift('${g.id}')">reservieren</button>`;
  }

  if (reservedByMe) {
    return `<button onclick="unreserveGift('${g.id}')">rückgängig</button>`;
  }

  return `<button disabled>vergeben</button>`;
})()}
        </div>`;
    });
  });

  list.innerHTML = html;
}

function getLocalToken(id) {
  return localStorage.getItem("gift_token_" + id) || null;
}
function setLocalToken(id, token) {
  localStorage.setItem("gift_token_" + id, token);
}
function clearLocalToken(id) {
  localStorage.removeItem("gift_token_" + id);
}
function randomToken() {
  const arr = new Uint8Array(16);
  crypto.getRandomValues(arr);
  return Array.from(arr).map(b => b.toString(16).padStart(2, "0")).join("");
}

window.reserveGift = async (id) => {
  const ok = confirm("Möchtest du dieses Geschenk wirklich reservieren?");
  if (!ok) return;

  const token = randomToken();

  const { error } = await sb
    .from("gifts")
    .update({ reserved: true, reserved_token: token, reserved_at: new Date().toISOString() })
    .eq("id", id)
    .eq("reserved", false);

  if (error) {
    alert("Konnte nicht reservieren. Bitte neu laden.");
    console.error(error);
    return;
  }

  setLocalToken(id, token);
  load();
};

window.unreserveGift = async (id) => {
  const ok = confirm("Reservierung wirklich rückgängig machen?");
  if (!ok) return;

  const token = getLocalToken(id);
  if (!token) {
    alert("Du kannst nur deine eigene Reservierung rückgängig machen.");
    return;
  }

  const { error } = await sb
    .from("gifts")
    .update({ reserved: false, reserved_token: null, reserved_at: null })
    .eq("id", id)
    .eq("reserved_token", token);

  if (error) {
    alert("Konnte nicht freigeben. Bitte neu laden.");
    console.error(error);
    return;
  }

  clearLocalToken(id);
  load();
};

load();
</script>
</body>
</html>
