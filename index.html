<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>Unsere Wunschliste</title>
  <meta name="robots" content="noindex, nofollow">

  <style>
    :root {
      /* Premium Minimal Palette */
      --bg-root: #F9F8F6;
      --bg-card: #FFFFFF;
      --bg-panel: #F2F1EF;

      --text-primary: #1D1D1F;
      --text-secondary: #86868B;
      --text-tertiary: #C7C7CC;

      --accent: #1D1D1F;
      /* Calm accent */

      --btn-bg: #EAEAEA;
      --btn-text: #1D1D1F;
      --btn-bg-hover: #E1E1E1;

      --radius-card: 16px;
      --radius-btn: 999px;
      --radius-input: 12px;

      --shadow-soft: 0 2px 12px rgba(0, 0, 0, 0.03);
      --shadow-hover: 0 4px 20px rgba(0, 0, 0, 0.05);

      --ease: cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      outline: none;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg-root);
      color: var(--text-primary);
      margin: 0;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      padding-bottom: 120px;
    }

    /* Typography */
    h1 {
      font-size: 26px;
      font-weight: 600;
      text-align: center;
      margin: 0 0 16px 0;
      letter-spacing: -0.015em;
    }

    h2 {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-secondary);
      margin: 0;
    }

    p.intro {
      font-size: 16px;
      line-height: 1.6;
      color: #666;
      text-align: center;
      max-width: 540px;
      margin: 0 auto 32px auto;
      font-weight: 400;
    }

    .wrap {
      max-width: 680px;
      margin: 0 auto;
      padding: 60px 24px;
    }

    /* Hero */
    .hero {
      width: 100%;
      height: 380px;
      object-fit: cover;
      border-radius: var(--radius-card);
      margin-bottom: 40px;
      box-shadow: var(--shadow-soft);
      filter: sepia(0.05) contrast(0.96);
    }

    /* Progress Bar */
    .progress-container {
      margin-bottom: 40px;
      text-align: center;
    }

    .progress-text {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      font-weight: 500;
    }

    .progress-track {
      width: 100%;
      height: 4px;
      background: #E5E5E5;
      border-radius: 2px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--text-secondary);
      width: 0%;
      transition: width 1s var(--ease);
    }

    /* Controls (Search, Sort, Filter) */
    .controls {
      background: var(--bg-card);
      padding: 20px;
      border-radius: var(--radius-card);
      box-shadow: var(--shadow-soft);
      margin-bottom: 32px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .search-row {
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 12px 16px 12px 40px;
      font-size: 15px;
      border: 1px solid #E5E5E5;
      border-radius: var(--radius-input);
      background: #FCFCFC;
      transition: all 0.2s;
    }

    .search-input:focus {
      border-color: #CCC;
      background: #FFF;
    }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      width: 16px;
      height: 16px;
      fill: var(--text-secondary);
      pointer-events: none;
    }

    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
    }

    .toggles {
      display: flex;
      gap: 12px;
    }

    .toggle-btn {
      background: transparent;
      border: 1px solid #E5E5E5;
      padding: 8px 14px;
      border-radius: 99px;
      font-size: 13px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
    }

    .toggle-btn.active {
      background: var(--text-primary);
      color: #FFF;
      border-color: var(--text-primary);
    }

    .sort-select {
      border: none;
      background: transparent;
      font-size: 13px;
      color: var(--text-primary);
      font-weight: 500;
      cursor: pointer;
      padding-right: 16px;
      text-align: right;
      appearance: none;
      /* simple cleaner look */
      /* Custom arrow via bg image if desired, keeping simple for now */
    }

    /* Gift List */
    .section-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 40px 0 16px 0;
      padding: 0 4px;
      cursor: pointer;
      user-select: none;
    }

    .section-title:hover {
      opacity: 0.8;
    }

    .section-chevron {
      width: 12px;
      height: 12px;
      fill: var(--text-secondary);
      transition: transform 0.3s;
    }

    .section-title.collapsed .section-chevron {
      transform: rotate(-90deg);
    }

    .gift-group {
      transition: height 0.3s var(--ease), opacity 0.3s var(--ease);
      overflow: hidden;
    }

    .gift-group.collapsed {
      height: 0 !important;
      opacity: 0;
    }

    /* Gift Item (No Image) */
    .item {
      background: var(--bg-card);
      padding: 24px;
      margin-bottom: 12px;
      border-radius: var(--radius-card);
      display: grid;
      grid-template-columns: 1fr auto;
      /* Content | Button */
      gap: 20px;
      /* whitespace */
      align-items: center;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.02);
      transition: all 0.2s var(--ease);
      border: 1px solid transparent;
    }

    .item:hover {
      box-shadow: var(--shadow-hover);
      transform: translateY(-1px);
      border-color: rgba(0, 0, 0, 0.03);
    }

    /* Reserved by Me Highlight */
    .item.my-reservation {
      border: 1px solid #E0E0E0;
      background: #FFFEFA;
    }

    .item-content {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
    }

    .item-title {
      font-size: 17px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .meta {
      font-size: 14px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .meta a {
      color: var(--text-secondary);
      text-decoration: none;
      position: relative;
      transition: color 0.2s;
    }

    .meta a:hover {
      color: var(--text-primary);
    }

    .meta a::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 1px;
      background: currentColor;
      opacity: 0.3;
    }

    .sep {
      width: 2px;
      height: 2px;
      background: #CCC;
      border-radius: 50%;
    }

    /* Buttons */
    button {
      background: var(--btn-bg);
      color: var(--btn-text);
      border: none;
      padding: 10px 18px;
      border-radius: var(--radius-btn);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
      min-width: 100px;
      text-align: center;
    }

    button:hover:not(:disabled) {
      background: var(--btn-bg-hover);
    }

    button.undo {
      background: transparent;
      color: var(--text-secondary);
      border: 1px solid #E5E5E5;
    }

    button.undo:hover {
      border-color: #CCC;
      color: var(--text-primary);
    }

    button:disabled {
      background: #F5F5F5;
      color: #CCC;
      cursor: default;
    }

    /* States */
    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
      font-size: 15px;
    }

    /* My Reservations Special Section */
    #my-reservations-section {
      background: #F4F4F4;
      border-radius: var(--radius-card);
      padding: 24px;
      margin-bottom: 40px;
      display: none;
      /* hidden by default */
    }

    #my-reservations-section h2 {
      margin-bottom: 16px;
      margin-top: 0;
      color: #333;
    }

    #my-reservations-list .item {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      background: #FFF;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(4px);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 999;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }

    .modal-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }

    .modal {
      background: #FFF;
      width: 90%;
      max-width: 340px;
      padding: 32px;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      text-align: center;
      transform: scale(0.95);
      transition: transform 0.3s;
    }

    .modal-overlay.active .modal {
      transform: scale(1);
    }

    .modal h3 {
      font-size: 18px;
      margin: 0 0 12px 0;
    }

    .modal p {
      font-size: 15px;
      color: #666;
      margin: 0 0 24px 0;
      line-height: 1.5;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
    }

    .modal-btn {
      flex: 1;
      padding: 12px;
      border-radius: 12px;
      font-size: 15px;
    }

    .modal-btn.primary {
      background: #1D1D1F;
      color: #FFF;
    }

    .modal-btn.secondary {
      background: #F5F5F5;
      color: #333;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: #222;
      color: #FFF;
      padding: 12px 24px;
      border-radius: 99px;
      font-size: 14px;
      opacity: 0;
      transition: all 0.4s;
      z-index: 1000;
      pointer-events: none;
    }

    .toast.active {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* Skeleton */
    .skeleton {
      height: 72px;
      background: #EEE;
      border-radius: var(--radius-card);
      margin-bottom: 12px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% {
        opacity: 0.5;
      }

      50% {
        opacity: 0.8;
      }

      border: 1px solid rgba(0, 0, 0, 0.05);
      cursor: pointer;
      transition: all 0.2s;
    }

    .iban-container:hover {
      border-color: #CCC;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .iban-container:active {
      transform: translateY(0);
    }

    .iban-text {
      font-family: -apple-system, monospace;
      /* Monospace for numbers feels correct but let's test sans */
      font-family: inherit;
      /* Keep sans for elegance */
      font-weight: 500;
      font-size: 15px;
      letter-spacing: 0.02em;
      color: #333;
    }

    .copy-icon {
      width: 16px;
      height: 16px;
      fill: #888;
    }

    @media (max-width: 600px) {
      .wrap {
        padding: 40px 20px;
      }

      .hero {
        height: 280px;
      }

      .item {
        grid-template-columns: 1fr;
        gap: 16px;
        padding: 20px;
      }

      button {
        width: 100%;
        margin-top: 4px;
      }

      .filter-row {
        flex-direction: column;
        align-items: stretch;
      }

      .toggles {
        justify-content: space-between;
      }

      .sort-select {
        text-align: left;
        margin-top: 8px;
      }

      .group-gift {
        padding: 24px 20px;
      }

      .iban-container {
        width: 100%;
        justify-content: center;
      }

      .iban-text {
        font-size: 13px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
    }
  </style>
</head>

<body>
  <div class="wrap">

    <img src="https://drive.google.com/thumbnail?id=1WYWYZjvu1wDPXqNuzFNPFI2quZTky3q0&sz=w2000" alt="Brautpaar"
      class="hero">

    <h1>Unsere Hochzeitswunschliste</h1>
    <p class="intro">
      Wir freuen uns, dass ihr diesen besonderen Tag mit uns feiert. Geschenke sind natürlich kein Muss.
    </p>

    <!-- Group Gift Section -->
    <div class="group-gift">
      <h2>Sammelgeschenk – KPM Kurland</h2>
      <p>
        Wer sich an dem KPM Kurland Sammelgeschenk beteiligen möchte,
        kann dies gerne über unseren Trauzeugen Max Tiefenbacher tun.
      </p>

      <div class="iban-container" onclick="window.app.copyIBAN()" title="IBAN kopieren">
        <svg class="copy-icon" viewBox="0 0 24 24">
          <path
            d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z" />
        </svg>
        <span class="iban-text">DE89 2007 0024 0191 3888 02</span>
      </div>
      <div style="font-size: 13px; color: #888; margin-top: 8px;">Max Tiefenbacher</div>
    </div>

    <!-- Progress -->
    <div class="progress-container" id="progress-container" style="display:none;">
      <div class="progress-text" id="progress-text">0 von 0 Wünschen erfüllt</div>
      <div class="progress-track">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
    </div>

    <!-- Controls -->
    <div class="controls">
      <div class="search-row">
        <svg class="search-icon" viewBox="0 0 24 24">
          <path
            d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
        </svg>
        <input type="text" id="search-input" class="search-input" placeholder="Wunsch suchen...">
      </div>
      <div class="filter-row">
        <div class="toggles">
          <button class="toggle-btn" id="filter-free">Nur Verfügbare</button>
          <button class="toggle-btn" id="filter-mine">Meine Reservierungen</button>
        </div>
        <select id="sort-select" class="sort-select">
          <option value="cat">Kategorie</option>
          <option value="status">Status (Verfügbar zuerst)</option>
          <option value="price_asc">Preis (aufsteigend)</option>
          <option value="price_desc">Preis (absteigend)</option>
        </select>
      </div>
    </div>

    <!-- My Reservations Section -->
    <div id="my-reservations-section">
      <h2>Deine Reservierungen</h2>
      <div id="my-reservations-list"></div>
    </div>

    <!-- Main List -->
    <div id="list">
      <div class="skeleton"></div>
      <div class="skeleton"></div>
      <div class="skeleton"></div>
    </div>

  </div>

  <!-- Modal -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <h3 id="modalTitle">Titel</h3>
      <p id="modalText">Text</p>
      <div class="modal-actions">
        <button class="modal-btn secondary" id="modalCancel">Abbrechen</button>
        <button class="modal-btn primary" id="modalConfirm">Bestätigen</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">Aktion erfolgreich</div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://tpfovcyqqhqlyzcopiwt.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRwZm92Y3lxcWhxbHl6Y29waXd0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyMzQ0NDgsImV4cCI6MjA4MTgxMDQ0OH0.UBAnfI_s7vQkPMDmwZHLVTYUkmZIAMvS6sK0w60Cvps";

    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* --- global state --- */
    const state = {
      gifts: [], // Raw data
      filter: {
        search: "",
        showFreeOnly: false,
        showMineOnly: false
      },
      sort: "cat", // cat, status, price_asc, price_desc
      categoryState: {} // expanded/collapsed
    };

    /* --- helpers --- */
    function getLocalToken(id) { return localStorage.getItem("gift_token_" + id); }
    function setLocalToken(id, token) { localStorage.setItem("gift_token_" + id, token); }
    function clearLocalToken(id) { localStorage.removeItem("gift_token_" + id); }
    function randomToken() {
      const arr = new Uint8Array(16);
      crypto.getRandomValues(arr);
      return Array.from(arr).map(b => b.toString(16).padStart(2, "0")).join("");
    }

    function parsePrice(priceStr) {
      if (!priceStr) return Infinity; // No price = last
      const matches = priceStr.match(/[\d.,]+/);
      if (!matches) return Infinity;
      // Replace german decimal comma with dot if needed, remove thousands separators
      // Simple heuristic: remove "." if follows by ",". 
      // Let's stick to simple: remove non-numeric chars, keep last dot/comma as decimal
      let numStr = matches[0].replace(/\./g, "").replace(",", ".");
      const num = parseFloat(numStr);
      return isNaN(num) ? Infinity : num;
    }

    /* --- UI Rendering --- */

    function render() {
      // 1. Filter
      let filtered = state.gifts.filter(g => {
        const matchesSearch = g.title.toLowerCase().includes(state.filter.search.toLowerCase());

        let matchesToggle = true;
        const myToken = getLocalToken(g.id);
        const isMine = g.reserved && g.reserved_token && myToken && g.reserved_token === myToken;

        if (state.filter.showFreeOnly && g.reserved) matchesToggle = false;
        // "Show mine" overrides "show free" naturally if both checked (unlikely UX but safe logic)
        if (state.filter.showMineOnly && !isMine) matchesToggle = false;

        return matchesSearch && matchesToggle;
      });

      // 2. Sort
      filtered.sort((a, b) => {
        if (state.sort === 'price_asc') return parsePrice(a.Preis) - parsePrice(b.Preis);
        if (state.sort === 'price_desc') return parsePrice(b.Preis) - parsePrice(a.Preis);
        if (state.sort === 'status') {
          // Available first
          if (a.reserved === b.reserved) return a.title.localeCompare(b.title);
          return a.reserved ? 1 : -1;
        }
        // Default: Category then Title (Already sorted by Supabase roughly, but let's be strict)
        if (a.category !== b.category) return a.category.localeCompare(b.category);
        return a.title.localeCompare(b.title);
      });

      // 3. Render Progress
      const total = state.gifts.length;
      const reservedCount = state.gifts.filter(g => g.reserved).length;
      const width = total > 0 ? (reservedCount / total) * 100 : 0;
      document.getElementById('progress-fill').style.width = width + "%";
      document.getElementById('progress-text').textContent = `${reservedCount} von ${total} Wünschen erfüllt`;
      document.getElementById('progress-container').style.display = 'block';

      // 4. Render My Reservations
      const myGifts = state.gifts.filter(g => {
        const t = getLocalToken(g.id);
        return g.reserved && g.reserved_token && t && g.reserved_token === t;
      });
      const myResSection = document.getElementById('my-reservations-section');
      const myResList = document.getElementById('my-reservations-list');

      if (myGifts.length > 0) {
        myResSection.style.display = 'block';
        myResList.innerHTML = myGifts.map(g => renderItem(g, true)).join("");
      } else {
        myResSection.style.display = 'none';
      }

      // 5. Render Main List (Grouped by Category if sorting by Category)
      const listContainer = document.getElementById('list');

      if (state.sort === 'cat') {
        const cats = {};
        filtered.forEach(g => (cats[g.category] ??= []).push(g));

        if (Object.keys(cats).length === 0) {
          listContainer.innerHTML = `<div class="empty-state">Keine Geschenke gefunden.</div>`;
          return;
        }

        let html = "";
        for (const c in cats) {
          const isCollapsed = state.categoryState[c] === true; // default false (expanded)
          const chevronStyle = isCollapsed ? 'transform: rotate(-90deg);' : '';
          const groupClass = isCollapsed ? 'collapsed' : '';

          html += `
                    <div class="section-title ${isCollapsed ? 'collapsed' : ''}" onclick="window.app.toggleCat('${c}')">
                        <h2>${c}</h2>
                        <svg class="section-chevron" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                    </div>
                    <div class="gift-group ${groupClass}" id="cat-${c}">
                        ${cats[c].map(g => renderItem(g)).join("")}
                    </div>
                `;
        }
        listContainer.innerHTML = html;
      } else {
        // Flat list for other sort methods
        if (filtered.length === 0) {
          listContainer.innerHTML = `<div class="empty-state">Keine Geschenke gefunden.</div>`;
          return;
        }
        listContainer.innerHTML = filtered.map(g => renderItem(g)).join("");
      }
    }

    function renderItem(g, isMySection = false) {
      const myToken = getLocalToken(g.id);
      const isMine = g.reserved && g.reserved_token && myToken && g.reserved_token === myToken;

      // Button Logic
      let btn = "";
      if (!g.reserved) {
        btn = `<button onclick="window.app.reserve('${g.id}')">Reservieren</button>`;
      } else if (isMine) {
        btn = `<button class="undo" onclick="window.app.unreserve('${g.id}')">Bearbeiten</button>`;
      } else {
        btn = `<button disabled>Vergeben</button>`;
      }

      const priceHtml = g.Preis ? `<span>${g.Preis}</span><div class="sep"></div>` : "";

      return `
            <div class="item ${isMine ? 'my-reservation' : ''}">
                <div class="item-content">
                    <div class="item-title">${g.title}</div>
                    <div class="meta">
                        ${priceHtml}
                        <a href="${g.url}" target="_blank" rel="noopener">Zum Shop ↗</a>
                    </div>
                </div>
                ${btn}
            </div>
        `;
    }

    /* --- Interactions --- */

    // Modal
    function confirmAction(title, text, confirmBtnText = "Bestätigen") {
      return new Promise((resolve) => {
        const overlay = document.getElementById('modalOverlay');
        const btns = {
          confirm: document.getElementById('modalConfirm'),
          cancel: document.getElementById('modalCancel')
        };

        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalText').textContent = text;
        btns.confirm.textContent = confirmBtnText;

        const close = (val) => {
          overlay.classList.remove('active');
          btns.confirm.onclick = null;
          btns.cancel.onclick = null;
          resolve(val);
        };

        btns.confirm.onclick = () => close(true);
        btns.cancel.onclick = () => close(false);
        overlay.classList.add('active');
      });
    }

    // Toast
    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('active');
      setTimeout(() => t.classList.remove('active'), 2500);
    }

    /* --- App Logic --- */

    async function loadData() {
      const { data, error } = await sb.from("gifts").select("*").order("category").order("title");
      if (error || !data) {
        console.error(error);
        document.getElementById('list').innerHTML = `<div class="empty-state">Fehler beim Laden.</div>`;
        return;
      }
      state.gifts = data;
      render();
    }

    window.app = {
      toggleCat: (cat) => {
        state.categoryState[cat] = !state.categoryState[cat];
        render();
      },
      reserve: async (id) => {
        const ok = await confirmAction("Reservieren?", "Möchtest du diesen Wunsch für dich reservieren?", "Ja, reservieren");
        if (!ok) return;

        const token = randomToken();
        // Optimistic update locally
        const idx = state.gifts.findIndex(g => g.id === id);
        if (idx !== -1) {
          state.gifts[idx].reserved = true;
          state.gifts[idx].reserved_token = token;
          setLocalToken(id, token);
          render();
        }

        await sb.from("gifts").update({
          reserved: true, reserved_token: token, reserved_at: new Date().toISOString()
        }).eq("id", id).eq("reserved", false);

        loadData(); // Sync
        showToast("Reserviert!");
      },
      unreserve: async (id) => {
        const ok = await confirmAction("Freigeben?", "Möchtest du diesen Wunsch wieder freigeben?", "Ja, freigeben");
        if (!ok) return;

        const token = getLocalToken(id);
        // Optimistic
        const idx = state.gifts.findIndex(g => g.id === id);
        if (idx !== -1) {
          state.gifts[idx].reserved = false;
          state.gifts[idx].reserved_token = null;
          clearLocalToken(id);
          render();
        }

        await sb.from("gifts").update({
          reserved: false, reserved_token: null, reserved_at: null
        }).eq("id", id).eq("reserved_token", token);

        loadData();
        showToast("Freigegeben.");
      },
      copyIBAN: () => {
        const text = "DE89 2007 0024 0191 3888 02";
        navigator.clipboard.writeText(text.replace(/\s/g, "")).then(() => {
          showToast("IBAN kopiert");
        }).catch(err => {
          showToast("IBAN kopiert");
        });
      }
    };

    /* --- Event Listeners --- */
    document.getElementById('search-input').addEventListener('input', (e) => {
      state.filter.search = e.target.value;
      render();
    });

    document.getElementById('filter-free').addEventListener('click', (e) => {
      state.filter.showFreeOnly = !state.filter.showFreeOnly;
      e.target.classList.toggle('active', state.filter.showFreeOnly);
      render();
    });

    document.getElementById('filter-mine').addEventListener('click', (e) => {
      state.filter.showMineOnly = !state.filter.showMineOnly;
      e.target.classList.toggle('active', state.filter.showMineOnly);
      render();
    });

    document.getElementById('sort-select').addEventListener('change', (e) => {
      state.sort = e.target.value;
      render();
    });

    // Init
    loadData();

  </script>
</body>

</html>
