<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Hochzeitswünsche | Ea & Paul</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-body: #FAFAFA;
      --bg-card: #FFFFFF;
      --text-primary: #1A1A1A;
      --text-secondary: #666666;
      --radius-card: 16px;
      --radius-btn: 12px;
      --shadow-soft: 0 8px 30px rgba(0, 0, 0, 0.04);
      --btn-bg: #1A1A1A;
      --btn-text: #FFFFFF;
      --btn-bg-hover: #333333;
      --ease: cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      font-family: 'Outfit', sans-serif;
      background: var(--bg-body);
      color: var(--text-primary);
      line-height: 1.5;
    }

    .wrap {
      max-width: 720px;
      margin: 0 auto;
      padding: 60px 24px;
    }

    /* Hero */
    .hero {
      width: 100%;
      height: 360px;
      object-fit: cover;
      border-radius: var(--radius-card);
      margin-bottom: 40px;
      background: #EEE;
    }

    h1 {
      font-size: 32px;
      font-weight: 600;
      text-align: center;
      margin: 0 0 16px 0;
    }

    .intro {
      text-align: center;
      color: var(--text-secondary);
      margin-bottom: 48px;
      max-width: 480px;
      margin-left: auto;
      margin-right: auto;
    }

    /* Group Gift */
    .group-gift {
      background: #FFF;
      border: 1px solid #EAEAEA;
      border-radius: var(--radius-card);
      padding: 32px;
      margin-bottom: 40px;
      text-align: center;
    }

    .group-gift h2 {
      font-size: 18px;
      margin: 0 0 12px 0;
    }

    .group-gift p {
      color: #555;
      margin-bottom: 24px;
    }

    .iban-container {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      background: #F9F9F9;
      padding: 10px 18px;
      border-radius: 99px;
      border: 1px solid #EEE;
      cursor: pointer;
      font-family: monospace;
    }

    .copy-icon {
      width: 16px;
      height: 16px;
      fill: #888;
    }

    /* Release Section */
    .release-section {
      background: #FFF;
      border: 1px solid #EAEAEA;
      border-radius: var(--radius-card);
      padding: 24px;
      margin-bottom: 32px;
      text-align: center;
    }

    .release-section h2 {
      font-size: 14px;
      margin-bottom: 12px;
    }

    .release-section p {
      font-size: 13px;
      color: #666;
      margin-bottom: 20px;
    }

    /* Progress */
    .progress-container {
      margin-bottom: 32px;
    }

    .progress-text {
      text-align: center;
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .progress-track {
      height: 6px;
      background: #EEE;
      border-radius: 99px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--text-primary);
      width: 0;
      transition: width 0.8s var(--ease);
    }

    /* Controls */
    .controls {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 40px;
    }

    .search-row {
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 14px 14px 14px 44px;
      border: none;
      background: #FFF;
      border-radius: var(--radius-btn);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
      font-size: 15px;
    }

    .search-icon {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      width: 18px;
      fill: #999;
      pointer-events: none;
    }

    .filter-row {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .toggles {
      display: flex;
      gap: 8px;
    }

    .toggle-btn {
      background: transparent;
      border: 1px solid #E5E5E5;
      color: var(--text-secondary);
      padding: 8px 14px;
      font-size: 13px;
      border-radius: var(--radius-btn);
      cursor: pointer;
    }

    .toggle-btn.active {
      background: var(--text-primary);
      color: #FFF;
      border-color: var(--text-primary);
    }

    .sort-select {
      border: none;
      background: transparent;
      font-size: 13px;
      cursor: pointer;
    }

    /* Sections & Items */
    .section-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 40px 0 16px;
      cursor: pointer;
    }

    .section-chevron {
      width: 12px;
      height: 12px;
      fill: var(--text-secondary);
      transition: transform 0.3s;
    }

    .section-title.collapsed .section-chevron {
      transform: rotate(-90deg);
    }

    .gift-group {
      overflow: hidden;
      transition: height 0.3s var(--ease);
    }

    .gift-group.collapsed {
      height: 0 !important;
    }

    .item {
      background: var(--bg-card);
      padding: 24px;
      margin-bottom: 12px;
      border-radius: var(--radius-card);
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 20px;
      align-items: center;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.02);
    }

    .item.my-reservation {
      border: 1px solid #E0E0E0;
      background: #FFFEFA;
    }

    .item-title {
      font-size: 17px;
      font-weight: 500;
      margin-bottom: 6px;
    }

    .meta {
      font-size: 14px;
      color: var(--text-secondary);
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .meta a {
      color: inherit;
      text-decoration: none;
      border-bottom: 1px solid rgba(0, 0, 0, 0.2);
    }

    .sep {
      width: 2px;
      height: 2px;
      background: #CCC;
      border-radius: 50%;
    }

    /* Buttons */
    button {
      background: var(--btn-bg);
      color: var(--btn-text);
      border: none;
      padding: 10px 18px;
      border-radius: var(--radius-btn);
      font-size: 13px;
      cursor: pointer;
      font-family: inherit;
    }

    button:disabled {
      background: #F5F5F5;
      color: #CCC;
      cursor: default;
    }

    button.reserved {
      background: transparent;
      color: var(--text-secondary);
      border: 1px solid #E5E5E5;
    }

    button.undo {
      background: rgba(76, 175, 80, 0.05);
      color: #2E7D32;
      border: 1px solid #4CAF50;
    }

    /* My Reservations */
    #my-reservations-section {
      background: #F4F4F4;
      border-radius: var(--radius-card);
      padding: 24px;
      margin-bottom: 40px;
      display: none;
    }

    #my-reservations-section h2 {
      font-size: 18px;
      margin: 0 0 16px 0;
    }

    /* Modal & Pin */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(4px);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 999;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }

    .modal-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }

    .modal {
      background: #FFF;
      width: 90%;
      max-width: 360px;
      padding: 28px;
      border-radius: 20px;
      text-align: center;
      transform: scale(0.96);
      transition: transform 0.2s;
    }

    .modal-overlay.active .modal {
      transform: scale(1);
    }

    .modal h3 {
      margin: 0 0 12px;
    }

    .modal p {
      color: #666;
      font-size: 15px;
      margin: 0 0 20px;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
    }

    .modal-btn {
      flex: 1;
      padding: 12px;
      border-radius: 12px;
    }

    .modal-btn.secondary {
      background: #F5F5F5;
      color: #333;
    }

    .pin-input-container {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin: 20px 0;
    }

    .pin-digit {
      width: 48px;
      height: 56px;
      font-size: 24px;
      text-align: center;
      border: 1px solid #E5E5E5;
      border-radius: 12px;
      background: #FAFAFA;
    }

    .pin-digit:focus {
      border-color: #333;
      background: #FFF;
      outline: none;
    }

    /* Admin */
    .admin-badge {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #000;
      color: #FFF;
      padding: 4px 8px;
      font-size: 10px;
      border-radius: 4px;
      display: none;
      z-index: 2000;
    }

    body.admin-mode .admin-badge {
      display: block;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: #222;
      color: #FFF;
      padding: 12px 24px;
      border-radius: 99px;
      opacity: 0;
      pointer-events: none;
      transition: all 0.3s;
      z-index: 1000;
    }

    .toast.active {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* Responsive */
    @media(max-width:600px) {
      .wrap {
        padding: 40px 20px;
      }

      .hero {
        height: 260px;
      }

      .item {
        grid-template-columns: 1fr;
        gap: 16px;
      }

      .filter-row {
        flex-direction: column;
      }

      button {
        width: 100%;
      }
    }
  </style>
</head>

<body>

  <div class="admin-badge">ADMIN</div>

  <div class="wrap">
    <img src="https://drive.google.com/thumbnail?id=1WYWYZjvu1wDPXqNuzFNPFI2quZTky3q0&sz=w2000" class="hero"
      alt="Cover">
    <h1>Unsere Hochzeitswunschliste</h1>
    <p class="intro">Wir freuen uns, dass ihr diesen besonderen Tag mit uns feiert. Geschenke sind kein Muss.</p>

    <!-- ADMIN DASHBOARD -->
    <div id="admin-dashboard"
      style="display:none; background:#FFF0F0; border:2px solid #D32F2F; padding:20px; margin-bottom:40px; border-radius:16px;">
      <h2 style="color:#D32F2F; margin-top:0; font-size:18px;">Admin Dashboard</h2>
      <p style="font-size:14px; color:#555; margin-bottom:15px;">Alle Reservierungen im Überblick.</p>
      <div style="overflow-x:auto;">
        <table style="width:100%; border-collapse:collapse; font-size:13px; text-align:left;">
          <thead>
            <tr style="border-bottom:1px solid #CCC;">
              <th style="padding:8px;">Geschenk</th>
              <th style="padding:8px;">PIN</th>
              <th style="padding:8px;">Menge</th>
              <th style="padding:8px;">Aktion</th>
            </tr>
          </thead>
          <tbody id="admin-list"></tbody>
        </table>
      </div>
    </div>

    <!-- Group Gift -->
    <div class="group-gift">
      <h2>Sammelgeschenk – KPM Kurland</h2>
      <p>Wer sich beteiligen möchte, kann dies gerne über unseren Trauzeugen Max Tiefenbacher tun.</p>
      <div class="iban-container" onclick="app.copyIBAN()">
        <svg class="copy-icon" viewBox="0 0 24 24">
          <path
            d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z" />
        </svg>
        <span>DE89 2007 0024 0191 3888 02</span>
      </div>
      <div style="font-size:13px; color:#888; margin-top:8px;">Max Tiefenbacher</div>
    </div>

    <!-- Release Reservation -->
    <div class="release-section">
      <h2>Reservierung freigeben</h2>
      <p>Falls du einen Wunsch reserviert hast, kannst du ihn mit deinem Code hier freigeben.</p>
      <button class="modal-btn secondary" style="width:auto; padding:8px 16px;" onclick="app.openReleaseModal()">Mit
        Code freigeben</button>
    </div>

    <!-- Progress -->
    <div class="progress-container" id="progress-container">
      <div class="progress-text" id="progress-text">Lade Status...</div>
      <div class="progress-track">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
    </div>

    <!-- Controls -->
    <div class="controls">
      <div class="search-row">
        <svg class="search-icon" viewBox="0 0 24 24">
          <path
            d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zM9.5 14C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
        </svg>
        <input type="text" id="search-input" class="search-input" placeholder="Wunsch suchen...">
      </div>
      <div class="filter-row">
        <div class="toggles">
          <button class="toggle-btn" id="filter-free">Nur Verfügbare</button>
          <button class="toggle-btn" id="filter-mine">Meine Reservierungen</button>
        </div>
        <select id="sort-select" class="sort-select">
          <option value="cat">Kategorie</option>
          <option value="status">Status</option>
          <option value="price_asc">Preis (aufsteigend)</option>
          <option value="price_desc">Preis (absteigend)</option>
        </select>
      </div>
    </div>

    <!-- My Reservations -->
    <div id="my-reservations-section">
      <h2>Deine Reservierungen</h2>
      <div id="my-reservations-list"></div>
    </div>

    <!-- List -->
    <div id="list">
      <div class="empty-state">Lade Liste...</div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <h3 id="modalTitle"></h3>
      <div id="modalBody"></div> <!-- Need div for innerHTML -->
      <div class="modal-actions">
        <button class="modal-btn secondary" id="modalCancel">Abbrechen</button>
        <button class="modal-btn primary" id="modalConfirm">Bestätigen</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://tpfovcyqqhqlyzcopiwt.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRwZm92Y3lxcWhxbHl6Y29waXd0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyMzQ0NDgsImV4cCI6MjA4MTgxMDQ0OH0.UBAnfI_s7vQkPMDmwZHLVTYUkmZIAMvS6sK0w60Cvps";
    const ADMIN_SECRET = "CHANGE_ME_TO_A_LONG_SECRET";

    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* --- State --- */
    const state = {
      gifts: [],
      reservations: [],
      contributions: [], // New for group gifts
      allReservations: [],
      allContributions: [], // Admin only
      userPins: [],
      filter: { search: "", showFreeOnly: false, showMineOnly: false },
      sort: "cat",
      categoryState: {},
      isAdmin: false
    };

    /* --- Helpers --- */
    function loadPins() { try { state.userPins = JSON.parse(localStorage.getItem("user_pins") || "[]"); } catch (e) { state.userPins = []; } }
    function savePin(pin) {
      if (!state.userPins.includes(pin)) {
        state.userPins.push(pin);
        localStorage.setItem("user_pins", JSON.stringify(state.userPins));
      }
    }

    function getAvailable(g) {
      if (g.is_group_gift) {
        // Logic for group gift availability? 
        // It's always "available" for contribution unless specific logic.
        // But for sorting/filtering, let's say available if not fully funded?
        const current = getContributionTotal(g.id);
        if (g.target_amount > 0 && current >= g.target_amount) return 0; // Fully funded
        return 1; // Available
      }
      return Math.max(0, (g.quantity || 1) - (g.reserved_quantity || 0));
    }

    function getContributionTotal(giftId) {
      const list = state.isAdmin ? state.allContributions : state.contributions;
      // Note: Normal user usually only fetches their own if we filter? 
      // Wait, for progress bar we need ALL contributions sum.
      // So standard fetch must get all contributions (public info).
      return state.contributions.filter(c => c.gift_id === giftId).reduce((sum, c) => sum + (parseFloat(c.amount) || 0), 0);
    }

    function isReservedByMe(g) {
      if (g.is_group_gift && state.contributions) {
        return state.contributions.some(c => c.gift_id === g.id && state.userPins.includes(c.pin));
      }
      return state.reservations && state.reservations.some(r => r.gift_id === g.id && state.userPins.includes(r.pin));
    }

    function parsePrice(s) {
      if (!s) return Infinity;
      const m = String(s).match(/[\d.,]+/);
      if (!m) return Infinity;
      return parseFloat(m[0].replace(/\./g, "").replace(",", "."));
    }

    function escape(s) { return String(s || "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;"); }
    function catKey(c) { return encodeURIComponent(String(c || "")); }

    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg; t.classList.add('active');
      setTimeout(() => t.classList.remove('active'), 2500);
    }

    /* --- Logic --- */
    window.app = {

      toggleCat: (k) => { state.categoryState[k] = !state.categoryState[k]; render(); },
      copyIBAN: () => navigator.clipboard.writeText("DE89200700240191388802").then(() => showToast("IBAN kopiert")),

      reserve: async (id) => {
        const g = state.gifts.find(x => x.id === id);
        if (!g) return;

        // Check if available first locally
        if (getAvailable(g) < 1) { showToast("Nicht mehr verfügbar."); return; }

        const pin = await requestPin("Wunsch reservieren", "Bitte wähle einen 4-stelligen Code.");
        if (!pin) return;

        // Critical Path: Re-check Availability from DB
        const { data: fresh, error: fErr } = await sb.from("gifts").select("quantity, reserved_quantity").eq("id", id).single();
        if (fErr || !fresh) { showToast("Fehler beim Prüfen."); return; }

        if (Math.max(0, fresh.quantity - (fresh.reserved_quantity || 0)) < 1) {
          showToast("Leider war jemand schneller.");
          loadData();
          return;
        }

        // 1. Insert Reservation
        const { error: insErr } = await sb.from("reservations").insert({ gift_id: id, pin: pin, qty: 1 });
        if (insErr) {
          console.error(insErr);
          if (insErr.code === '23505') showToast("Code bereits vergeben? Bitte ändern.");
          else showToast("Fehler beim Speichern. (Policy?)");
          return;
        }

        // 2. Increment Gift Counter
        const newQ = (fresh.reserved_quantity || 0) + 1;
        const { error: upErr } = await sb.from("gifts").update({ reserved_quantity: newQ }).eq("id", id);

        if (upErr) console.error("Update failed", upErr);

        savePin(pin);
        showToast("Reserviert!");
        loadData();
      },

      unreserve: async (id) => {
        const myRes = state.reservations.filter(r => r.gift_id === id && state.userPins.includes(r.pin));
        if (myRes.length === 0) return;
        const r = myRes[0]; // Take first

        if (!(await confirm("Freigeben?", "Möchtest du diese Reservierung freigeben?"))) return;

        // 1. Delete
        const { error: delErr } = await sb.from("reservations").delete().match({ gift_id: id, pin: r.pin });
        if (delErr) { showToast("Fehler beim Löschen."); return; }

        // 2. Decrement
        const { data: fresh } = await sb.from("gifts").select("reserved_quantity").eq("id", id).single();
        if (fresh) {
          const newQ = Math.max(0, (fresh.reserved_quantity || 0) - r.qty);
          await sb.from("gifts").update({ reserved_quantity: newQ }).eq("id", id);
        }

        showToast("Freigegeben.");
        loadData();
      },

      // Group Gift: Contribute
      contribute: async (id) => {
        const g = state.gifts.find(x => x.id === id);
        if (!g) return;

        // Custom Input Modal
        const input = await requestContributionInput(g.title);
        if (!input) return; // Cancelled

        const { amount, name, message, pin } = input;

        // Insert
        const { error } = await sb.from("contributions").insert({
          gift_id: id,
          amount: amount,
          name: name,
          message: message,
          pin: pin
        });

        if (error) {
          console.error(error);
          showToast("Fehler beim Speichern.");
          return;
        }

        savePin(pin);
        showToast("Beitrag gespeichert!");
        loadData();
      },

      // Group Gift: Remove Contribution
      removeContribution: async (id) => {
        // Check which contributions are mine
        const myContribs = state.contributions.filter(c => c.gift_id === id && state.userPins.includes(c.pin));
        if (myContribs.length === 0) return;

        // If multiple, maybe ask which one? For simplicity, just list them or take latest?
        // Simplest: Just remove the most recent one.
        const c = myContribs[myContribs.length - 1];

        if (!(await confirm("Beitrag zurückziehen?", `Deinen Beitrag von ${c.amount}€ entfernen?`))) return;

        const { error } = await sb.from("contributions").delete().eq("id", c.id);
        if (error) { showToast("Fehler beim Entfernen."); return; }

        showToast("Entfernt.");
        loadData();
      },

      openReleaseModal: async () => {
        const pin = await requestPin("Reservierung finden", "Bitte gib deinen Code ein.");
        if (!pin) return;

        // Check remote reservations
        const { data: list, error } = await sb.from("reservations").select("*, gifts(title)").eq("pin", pin);

        // Check remote contributions
        const { data: cList } = await sb.from("contributions").select("*, gifts(title)").eq("pin", pin);

        if ((!list || list.length === 0) && (!cList || cList.length === 0)) {
          showToast("Keine Einträge gefunden."); return;
        }

        // Prioritize Reservations first, then Contributions
        if (list && list.length > 0) {
          const item = list[0];
          const title = item.gifts ? item.gifts.title : "Unbekannt";
          if (!(await confirm("Gefunden", `Freigeben: "${escape(title)}"?`))) return;
          await sb.from("reservations").delete().eq("id", item.id);
          const { data: g } = await sb.from("gifts").select("reserved_quantity").eq("id", item.gift_id).single();
          if (g) {
            await sb.from("gifts").update({ reserved_quantity: Math.max(0, g.reserved_quantity - item.qty) }).eq("id", item.gift_id);
          }
        } else if (cList && cList.length > 0) {
          const item = cList[0];
          const title = item.gifts ? item.gifts.title : "Unbekannt";
          if (!(await confirm("Beitrag gefunden", `Beitrag für "${escape(title)}" (${item.amount}€) entfernen?`))) return;
          await sb.from("contributions").delete().eq("id", item.id);
        }

        savePin(pin);
        showToast("Erledigt.");
        loadData();
      },

      // Admin Action: Delete a specific reservation by ID
      adminDelete: async (resId, giftId, qty, isContribution = false) => {
        if (!(await confirm("ADMIN LÖSCHEN", "Wirklich löschen?"))) return;

        const table = isContribution ? "contributions" : "reservations";
        const { error } = await sb.from(table).delete().eq("id", resId);

        if (error) {
          console.error(error);
          showToast("Fehler.");
          return;
        }

        if (!isContribution) {
          // Decrement reserved qty only for reservations
          const { data: fresh } = await sb.from("gifts").select("reserved_quantity").eq("id", giftId).single();
          if (fresh) {
            const newQ = Math.max(0, (fresh.reserved_quantity || 0) - qty);
            await sb.from("gifts").update({ reserved_quantity: newQ }).eq("id", giftId);
          }
        }

        showToast("Gelöscht.");
        loadData();
      },

      adminReset: async (id) => {
        if (!(await confirm("ADMIN", "Reset completely?"))) return;
        await sb.from("reservations").delete().eq("gift_id", id);
        await sb.from("gifts").update({ reserved_quantity: 0, reserved: false }).eq("id", id);
        loadData();
      }
    };

    /* --- Modal --- */
    function confirm(title, text) {
      return new Promise(resolve => {
        const el = document.getElementById('modalOverlay');
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalBody').innerHTML = `<p>${text}</p>`;
        document.getElementById('modalConfirm').textContent = "Ja";

        const close = (v) => { el.classList.remove('active'); resolve(v); };
        document.getElementById('modalConfirm').onclick = () => close(true);
        document.getElementById('modalCancel').onclick = () => close(false);
        el.classList.add('active');
      });
    }

    function requestPin(title, txt) {
      return new Promise(resolve => {
        const html = `<p>${txt}</p>
            <div class="pin-input-container">
               <input class="pin-digit" type="tel" maxlength="1"><input class="pin-digit" type="tel" maxlength="1">
               <input class="pin-digit" type="tel" maxlength="1"><input class="pin-digit" type="tel" maxlength="1">
            </div>`;

        const el = document.getElementById('modalOverlay');
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalBody').innerHTML = html;
        const btn = document.getElementById('modalConfirm');
        btn.textContent = "Bestätigen"; btn.disabled = true;

        const inputs = el.querySelectorAll('.pin-digit');
        inputs.forEach((inp, i) => {
          inp.value = "";
          inp.oninput = (e) => {
            if (!/^\d$/.test(inp.value)) inp.value = "";
            if (inp.value && i < 3) inputs[i + 1].focus();
            check();
          };
          inp.onkeydown = (e) => { if (e.key === "Backspace" && !inp.value && i > 0) inputs[i - 1].focus(); };
        });

        const check = () => {
          const code = Array.from(inputs).map(x => x.value).join('');
          btn.disabled = code.length !== 4;
          return code;
        };

        const close = (val) => { el.classList.remove('active'); resolve(val); };
        btn.onclick = () => close(check());
        document.getElementById('modalCancel').onclick = () => close(null);

        el.classList.add('active');
        setTimeout(() => inputs[0].focus(), 100);
      });
    }

    function requestContributionInput(giftTitle) {
      return new Promise(resolve => {
        const el = document.getElementById('modalOverlay');
        document.getElementById('modalTitle').textContent = "Beteiligen an: " + giftTitle;

        const html = `
                <div style="text-align:left; margin-bottom:20px;">
                    <label style="display:block; font-size:13px; margin-bottom:4px; color:#666;">Betrag (€)</label>
                    <input type="number" id="inp-amount" style="width:100%; padding:10px; border:1px solid #CCC; border-radius:8px; font-size:16px; margin-bottom:12px;" placeholder="z.B. 50">
                    
                    <label style="display:block; font-size:13px; margin-bottom:4px; color:#666;">Name (optional)</label>
                    <input type="text" id="inp-name" style="width:100%; padding:10px; border:1px solid #CCC; border-radius:8px; font-size:16px; margin-bottom:12px;" placeholder="Dein Name">
                    
                    <label style="display:block; font-size:13px; margin-bottom:4px; color:#666;">Nachricht (optional)</label>
                    <textarea id="inp-msg" style="width:100%; padding:10px; border:1px solid #CCC; border-radius:8px; font-size:14px; resize:none; margin-bottom:12px;" rows="2" placeholder="Deine Nachricht an das Brautpaar..."></textarea>
                    
                    <label style="display:block; font-size:13px; margin-bottom:4px; color:#666;">Dein PIN (4-stellig)</label>
                    <div class="pin-input-container" style="justify-content:flex-start; margin:0;">
                       <input class="pin-digit" type="tel" maxlength="1"><input class="pin-digit" type="tel" maxlength="1">
                       <input class="pin-digit" type="tel" maxlength="1"><input class="pin-digit" type="tel" maxlength="1">
                    </div>
                </div>
            `;
        document.getElementById('modalBody').innerHTML = html;
        const btn = document.getElementById('modalConfirm');
        btn.textContent = "Speichern"; btn.disabled = true;

        const inputs = el.querySelectorAll('.pin-digit');
        const amountInp = document.getElementById('inp-amount');

        const check = () => {
          const code = Array.from(inputs).map(x => x.value).join('');
          const amt = parseFloat(amountInp.value);
          btn.disabled = code.length !== 4 || isNaN(amt) || amt <= 0;
          return {
            amount: amt,
            name: document.getElementById('inp-name').value,
            message: document.getElementById('inp-msg').value,
            pin: code
          };
        };

        amountInp.oninput = check;

        inputs.forEach((inp, i) => {
          inp.value = "";
          inp.oninput = (e) => {
            if (!/^\d$/.test(inp.value)) inp.value = "";
            if (inp.value && i < 3) inputs[i + 1].focus();
            check();
          };
          inp.onkeydown = (e) => { if (e.key === "Backspace" && !inp.value && i > 0) inputs[i - 1].focus(); };
        });

        const close = (val) => { el.classList.remove('active'); resolve(val); };
        btn.onclick = () => close(check());
        document.getElementById('modalCancel').onclick = () => close(null);

        el.classList.add('active');
        setTimeout(() => amountInp.focus(), 100);
      });
    }

    /* --- Loader --- */
    async function loadData() {
      // Toggle Admin Mode
      const params = new URLSearchParams(window.location.search);
      if (params.get("admin") === ADMIN_SECRET || window.location.hash.includes("master") || window.location.href.includes("/master")) {
        state.isAdmin = true; document.body.classList.add('admin-mode');
      }

      loadPins();

      // Load Gifts
      const { data: gs, error: gErr } = await sb.from("gifts").select("*").order("category").order("title");
      if (gErr) { document.getElementById('list').innerHTML = `<div class="empty-state">Fehler.</div>`; return; }
      state.gifts = gs;

      // Group Gifts Logic: Always fetch all contributions to show progress
      // Wrap in try-catch in case table doesn't exist yet (SQL failure)
      try {
        const { data: contribs, error: cErr } = await sb.from("contributions").select("*");
        if (cErr) throw cErr;
        state.contributions = contribs || [];
      } catch (e) {
        console.warn("Contributions table missing or error:", e);
        state.contributions = [];
      }

      // Load Reservations
      if (state.isAdmin) {
        const { data: allRes } = await sb.from("reservations").select("*, gifts(title)").order("created_at", { ascending: false });
        // Also fetch enriched contributions
        const { data: allContribs } = await sb.from("contributions").select("*, gifts(title)").order("created_at", { ascending: false });

        state.allReservations = allRes || [];
        state.allContributions = allContribs || [];

        renderAdmin();
        document.getElementById('admin-dashboard').style.display = 'block';

        // Admin sees all as "state.reservations" for main listing? No, keep separate.
        state.reservations = allRes || [];
      } else {
        // Normal User
        // RLS policy allows read all for contributions (for progress bar), so state.contributions is populated.
        // For reservations, fetch relevant if pin exists.
        // Or if RLS is public read, fetch all?
        // Let's assume public read for now as per previous policy.
        if (state.userPins.length > 0) {
          const { data: rs } = await sb.from("reservations").select("*").in("pin", state.userPins);
          state.reservations = rs || [];
        } else {
          state.reservations = [];
        }
      }

      render();
    }

    function renderAdmin() {
      const list = document.getElementById('admin-list');

      let html = "";

      // Reservations
      if (state.allReservations.length > 0) {
        html += `<tr style="background:#EEE"><td colspan="4" style="padding:4px 8px; font-weight:bold;">Reservierungen</td></tr>`;
        html += state.allReservations.map(r => {
          const title = r.gifts ? r.gifts.title : "???";
          return `<tr style="border-bottom:1px solid #EEE;">
                     <td style="padding:8px; font-weight:500;">${escape(title)}</td>
                     <td style="padding:8px; font-family:monospace;">${escape(r.pin)}</td>
                     <td style="padding:8px;">${r.qty}x</td>
                     <td style="padding:8px;">
                         <button style="background:#FFF0F0; color:#D32F2F; border:1px solid #D32F2F; padding:4px 10px; font-size:11px; border-radius:6px;" onclick="app.adminDelete('${r.id}', '${r.gift_id}', ${r.qty})">Löschen</button>
                     </td>
                 </tr>`;
        }).join("");
      }

      // Contributions
      if (state.allContributions.length > 0) {
        html += `<tr style="background:#EEE"><td colspan="4" style="padding:4px 8px; font-weight:bold; margin-top:10px;">Beiträge (Gruppe)</td></tr>`;
        html += state.allContributions.map(c => {
          const title = c.gifts ? c.gifts.title : "???";
          const msg = c.message ? `<div style="font-size:10px;color:#666;max-width:200px;text-overflow:ellipsis;overflow:hidden;white-space:nowrap;">"${escape(c.message)}"</div>` : "";
          return `<tr style="border-bottom:1px solid #EEE;">
                     <td style="padding:8px; font-weight:500;">${escape(title)}<br><span style="font-size:11px;color:#555">${escape(c.name || "-")}</span></td>
                     <td style="padding:8px; font-family:monospace;">${escape(c.pin)}</td>
                     <td style="padding:8px;">${c.amount}€</td>
                     <td style="padding:8px;">
                        ${msg}
                         <button style="background:#FFF0F0; color:#D32F2F; border:1px solid #D32F2F; padding:4px 10px; font-size:11px; border-radius:6px;" onclick="app.adminDelete('${c.id}', '${c.gift_id}', 0, true)">Löschen</button>
                     </td>
                 </tr>`;
        }).join("");
      }

      if (!html) html = `<tr><td colspan="4" style="padding:15px;text-align:center;">Keine Einträge.</td></tr>`;

      list.innerHTML = html;
    }

    function render() {
      // Stats
      const total = state.gifts.length;
      // Fulfillment: For group gifts, fulfilled if >= target?
      const fulfilled = state.gifts.filter(g => {
        if (g.is_group_gift) return getContributionTotal(g.id) >= (g.target_amount || 1);
        return getAvailable(g) === 0;
      }).length;

      document.getElementById('progress-fill').style.width = (total > 0 ? (fulfilled / total) * 100 : 0) + "%";
      document.getElementById('progress-text').textContent = `${fulfilled} von ${total} Wünschen erfüllt`;

      // Render Lists
      const sLower = state.filter.search.toLowerCase();
      const filtered = state.gifts.filter(g => {
        const has = g.title.toLowerCase().includes(sLower);
        const my = isReservedByMe(g);

        // Free Only:
        if (state.filter.showFreeOnly) {
          if (g.is_group_gift) {
            // Hide if fully funded?
            if (getContributionTotal(g.id) >= (g.target_amount || 1)) return false;
          } else {
            if (getAvailable(g) === 0) return false;
          }
        }

        if (state.filter.showMineOnly && !my) return false;
        return has;
      });

      // Sort
      filtered.sort((a, b) => {
        if (state.sort.includes('price')) {
          const pa = parsePrice(a.Preis), pb = parsePrice(b.Preis);
          return state.sort === 'price_asc' ? pa - pb : pb - pa;
        }
        if (state.sort === 'status') {
          const aa = getAvailable(a) > 0, bb = getAvailable(b) > 0;
          if (aa === bb) return a.title.localeCompare(b.title);
          return aa ? -1 : 1;
        }
        if (a.category !== b.category) return (a.category || "").localeCompare(b.category || "");
        return a.title.localeCompare(b.title);
      });

      // HTML Gen
      let html = "";
      let cats = {};

      // Grouping
      if (state.sort === 'cat') {
        filtered.forEach(g => (cats[g.category] ||= []).push(g));
        for (let c in cats) {
          const key = catKey(c);
          const open = !state.categoryState[key];
          html += `<div class="section-title ${!open ? 'collapsed' : ''}" onclick="app.toggleCat('${key}')">
                   <h2>${escape(c)}</h2><svg class="section-chevron" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                </div>
                <div class="gift-group ${!open ? 'collapsed' : ''}" style="${!open ? 'height:0' : ''}">${cats[c].map(renderItem).join('')}</div>`;
        }
      } else {
        html = filtered.map(renderItem).join('');
      }

      if (!html) html = `<div class="empty-state">Nichts gefunden.</div>`;
      document.getElementById('list').innerHTML = html;

      // My Res Section
      const mine = state.gifts.filter(isReservedByMe);
      const mySec = document.getElementById('my-reservations-section');
      if (mine.length > 0) {
        mySec.style.display = 'block';
        document.getElementById('my-reservations-list').innerHTML = mine.map(g => renderItem(g, true)).join('');
      } else {
        mySec.style.display = 'none';
      }
    }

    function renderItem(g, isMySection = false) {
      if (g.is_group_gift) return renderGroupGiftItem(g, isMySection);

      const avail = getAvailable(g);
      const my = isReservedByMe(g);
      const price = g.Preis ? `<span>${escape(g.Preis)}</span><div class="sep"></div>` : "";

      let act = "";
      if (avail > 0) act = `<button onclick="app.reserve('${g.id}')">Reservieren</button>`;
      else if (my) act = `<button class="reserved" onclick="app.unreserve('${g.id}')">Meine Reservierung</button>`;
      else act = `<button disabled>Vergeben</button>`;

      if (avail > 0 && my) {
        act = `<button onclick="app.reserve('${g.id}')">Reservieren</button>`;
      }

      // If rendering in "My Section", show distinct Unreserve button
      if (isMySection) {
        act = `<button class="undo" onclick="app.unreserve('${g.id}')">Freigeben</button>`;
      }

      // Status
      let st = "";
      if (g.quantity > 1) {
        if (avail === 0) st = `<div style="color:#D32F2F; font-size:12px;">Alle ${g.quantity} V.</div>`;
        else st = `<div style="color:#2E7D32; font-size:12px;">${avail} von ${g.quantity} verfügbar</div>`;
      }

      const admin = state.isAdmin ? `<div style="margin-top:5px"><button style="background:black;color:white;padding:4px 8px;font-size:10px" onclick="app.adminReset('${g.id}')">RESET GIFT</button></div>` : "";

      return `<div class="item ${my ? 'my-reservation' : ''} ${my ? 'reserved-by-me' : ''}">
           <div class="item-content">
              <div class="item-title">${escape(g.title)}</div>
              <div class="meta">${price} <a href="${escape(g.url)}" target="_blank" rel="noopener">Zum Shop ↗</a></div>
              ${st}
           </div>
           <div style="flex-direction:column; display:flex; align-items:flex-end; gap:6px;">
              ${act}
              ${admin}
           </div>
        </div>`;
    }

    function renderGroupGiftItem(g, isMySection = false) {
      const current = getContributionTotal(g.id);
      const target = parseFloat(g.target_amount) || 1; // Avoid div/0
      const percent = Math.min(100, (current / target) * 100);
      const my = isReservedByMe(g); // Means I have contributed

      // Progress Bar
      const bar = `
            <div style="margin-top:8px;">
                <div style="display:flex; justify-content:space-between; font-size:12px; color:#555; margin-bottom:4px;">
                    <span>${current}€ gesammelt</span>
                    <span>Ziel: ${target}€</span>
                </div>
                <div style="height:6px; background:#EEE; border-radius:4px; overflow:hidden;">
                    <div style="height:100%; width:${percent}%; background:#4CAF50;"></div>
                </div>
            </div>
        `;

      let act = `<button style="background:#2E7D32;" onclick="app.contribute('${g.id}')">Beteiligen</button>`;

      if (isMySection) {
        act = `<button class="undo" onclick="app.removeContribution('${g.id}')">Beitrag zurückziehen</button>`;
      }

      const priceStr = g.Preis ? `<span>${escape(g.Preis)} (Ziel)</span><div class="sep"></div>` : "";

      return `<div class="item ${my ? 'my-reservation' : ''}" style="border-left:4px solid #4CAF50;">
           <div class="item-content" style="width:100%">
              <div class="item-title">${escape(g.title)} <span style="font-size:12px; font-weight:normal; color:#4CAF50; background:#E8F5E9; padding:2px 6px; border-radius:4px; margin-left:6px;">Sammelgeschenk</span></div>
              <div class="meta">${priceStr} <a href="${escape(g.url)}" target="_blank" rel="noopener">Details ↗</a></div>
              ${bar}
           </div>
           <div style="display:flex; flex-direction:column; align-items:flex-end; gap:6px; min-width:100px;">
              ${act}
           </div>
        </div>`;
    }

    // Init
    document.getElementById('search-input').oninput = (e) => { state.filter.search = e.target.value; render(); };
    document.getElementById('filter-free').onclick = (e) => { state.filter.showFreeOnly = !state.filter.showFreeOnly; e.target.classList.toggle('active'); render(); };
    document.getElementById('filter-mine').onclick = (e) => { state.filter.showMineOnly = !state.filter.showMineOnly; e.target.classList.toggle('active'); render(); };
    document.getElementById('sort-select').onchange = (e) => { state.sort = e.target.value; render(); };

    loadData();

  </script>
</body>

</html>
